<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>
    <style>
        .wrapper{
              align-items: center;
              justify-content: center;
              margin-top: 5px;
              margin-bottom: : 5px;
              display: flex;
              width: 100%;
                    }
        .btn-default {
                margin-right: 5px;
                margin-left: 5px;
                }
        .center {
            text-align: center;
    </style>
</head>
<body>

<button type="button" class="btn btn-info btn-lg" onclick="requestLicenseStart()" >Request License</button>

<div id="allLicenseModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Free licenses</h4>
            </div>
            <div class="modal-body">
                <div class="center">
                    <div id="allFreeLicenses-Table"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="confirmModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <h4 id="confirm"></h4>
                <div>
                    <button id="download-csv" class="btn btn-default" onclick="confirmLicenseRequest()">Confirm</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
	var freeLicensesTableData

    var licenseRequestData;


    function requestLicenseStart()
        {
            $("#allLicenseModal").modal("toggle");
            getFreeLicenses();
        }

	function getFreeLicenses()
	    {
	        var xmlHttp = new XMLHttpRequest();
	        var theURL = "http://localhost:8080/license/free"
	        xmlHttp.onreadystatechange = function()
	        {
	            if (this.readyState == 4 && this.status == 200)
	            {
	             freeLicensesTableData = JSON.parse(this.responseText);
	             buildFreeLicensesTable();
	            }
	            else
	            {

	            }
	        };
	        xmlHttp.open("GET", theURL , true);
	        xmlHttp.send();
	    }


    function buildFreeLicensesTable()
        {
            table = new Tabulator("#allFreeLicenses-Table",
            {
                data:freeLicensesTableData,
                layout:"fitColumns",
                paginationSize:5,
                movableColumns:true,
                resizableRows:true,
                printAsHtml:true,
                columns:[
                // {title:"ID", field:"uuid"},
                {title:"Software", field:"softwareName", hozAlign:"left"},
                {title:"Version", field:"softwareVersion", hozAlign:"left"},
                {title:"Purchase Date", field:"purchaseDate", hozAlign:"left"},
                {title:"Expiry Date", field:"expiryDate", hozAlign:"left"},
                {title:"License Key", field:"licenseKey", hozAlign:"left"},
                ],
                rowClick:function(e, row)
                {
                    var requestLicenseRowData = row.getData();
                    assignLicense(requestLicenseRowData);
                     $("#allLicenseModal").modal("toggle");
                     $("#confirmModal").modal("toggle");
                }
                }
                );
        }

        function assignLicense(requestLicenseRowData)
        {
            var license_key = requestLicenseRowData.licenseKey;
            var selectedUserID = "b5826164-56ec-460e-8492-f84ffed96cec";

            var newObject = {};

            newObject["license_key"] = license_key;
            newObject["user_id"] = selectedUserID;

            licenseRequestData = JSON.stringify(newObject);

            document.getElementById("confirm").innerHTML = "Request: " + requestLicenseRowData.softwareName + " " + requestLicenseRowData.softwareVersion + " [" + requestLicenseRowData.licenseKey + "]";
        }

        function confirmLicenseRequest()
        {
            var xmlHttp = new XMLHttpRequest();

            var theUrl = "http://localhost:8080/license_assign/add/user";
            xmlHttp.open("POST", theUrl);
            xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

            xmlHttp.onreadystatechange = function()
            {
                if (this.readyState == 4 && this.status == 201)
                {
                    alert("License Assigned");
                    getFreeLicenses();
                    $("#confirmModal").modal("toggle");

                }else if (this.readyState == 4 && this.status != 201)
                {
                    alert("Assignment Registration Error");
                }
            };

            xmlHttp.send(licenseRequestData);


        }


</script>
</body>
</html></html>