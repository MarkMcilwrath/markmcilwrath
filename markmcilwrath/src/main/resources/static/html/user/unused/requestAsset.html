<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>
    <style>
        .wrapper{
              align-items: center;
              justify-content: center;
              margin-top: 5px;
              margin-bottom: : 5px;
              display: flex;
              width: 100%;
                    }
        .btn-default {
                margin-right: 5px;
                margin-left: 5px;
                }
        .center {
            text-align: center;
    </style>
</head>
<body>

<button type="button" class="btn btn-info btn-lg"onclick="requestAssetStart()" >Request Asset</button>

<div id="allAssetsModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Free Assets</h4>
            </div>
            <div class="modal-body">
                <div class="center2">
                    <div id="allAssets-Table"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="confirmModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <h4 id="confirmAsset"></h4>
                <div>
                    <button id="download-csv" class="btn btn-default" onclick="confirmAssetRequest()">Confirm</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
	var freeAssetTableData
    var assetRequestData;

    function requestAssetStart()
        {
            $("#allAssetsModal").modal("toggle");
            getFreeAssets();
            
        }

	function getFreeAssets()
	    {
	        var xmlHttp = new XMLHttpRequest();
	        var theURL = "http://localhost:8080/asset/free"
	        xmlHttp.onreadystatechange = function()
	        {
	            if (this.readyState == 4 && this.status == 200)
	            {
	             freeAssetTableData = JSON.parse(this.responseText);
	             buildFreeAssetsTable();
	            }
	            else
	            {

	            }
	        };
	        xmlHttp.open("GET", theURL , true);
	        xmlHttp.send();
	    }


    function rebuildFreeAssetsTable()
        {
            table.redraw();
        }

    function buildFreeAssetsTable()
        {
            table = new Tabulator("#allAssets-Table",
            {
                data:freeAssetTableData,
                layout:"fitColumns",
                paginationSize:5,
                movableColumns:true,
                resizableRows:true,
                printAsHtml:true,
                columns:[
                // {title:"ID", field:"uuid"},
                {title:"Hardware", field:"name", hozAlign:"left"},
                {title:"Model", field:"model", hozAlign:"left"},
                {title:"Purchase Date", field:"purchaseDate", hozAlign:"left"},
                {title:"Serial Number", field:"serialNumber", hozAlign:"left"},
                {title:"Asset Tag", field:"assetTag", hozAlign:"left"},
                ],
                rowClick:function(e, row)
                {
                    var requestAssetRowData = row.getData();
                    console.log(requestAssetRowData);
                    assignAsset(requestAssetRowData);
                     $("#allAssetsModal").modal("toggle");
                     $("#confirmModal").modal("toggle");
                }
                }
                );
        }

        function assignAsset(requestAssetRowData)
        {
            var assetTag = requestAssetRowData.assetTag;
            var selectedUserID = "b5826164-56ec-460e-8492-f84ffed96cec";

            var newObject = {};

            newObject["assetTag"] = assetTag;
            newObject["userID"] = selectedUserID;

            assetRequestData = JSON.stringify(newObject);
            console.log(assetRequestData);

            document.getElementById("confirmAsset").innerHTML = "Request: " + requestAssetRowData.name + " " + requestAssetRowData.model + " [" + requestAssetRowData.assetTag + "]";
        }

        function confirmAssetRequest()
        {
            var xmlHttp = new XMLHttpRequest();

            var theUrl = "http://localhost:8080/asset_assign/add/user";
            xmlHttp.open("POST", theUrl);
            xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

            xmlHttp.onreadystatechange = function()
            {
                if (this.readyState == 4 && this.status == 201)
                {
                    alert("Asset Assigned");
                    getFreeAssets();
                    $("#confirmModal").modal("toggle");

                }else if (this.readyState == 4 && this.status != 201)
                {
                    alert("Assignment Registration Error");
                }
            };

            xmlHttp.send(assetRequestData);


        }


</script>
</body>
</html></html>