<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>
<body>

	<button type="button" class="btn btn-info btn-lg" onclick="startAddAsset()">Add Asset</button>

	<div id="addAssetModal" class="modal fade" role="dialog">
	    <div class="modal-dialog">
	        <div class="modal-content">

	            <div class="modal-header">
	                <button type="button" class="close" data-dismiss="modal">&times;</button>
	                <h4 class="modal-title">Add Asset</h4>
	            </div>

	            <div class="modal-body">
	                <form id="addAssetForm" name="addAssetForm">
	                    <div>
	                        <label for="serialNumber">Serial Number:</label>
	                        <input type="text" id="serialNumber" name="serialNumber">
	                    </div>
	                    <div>
	                        <label for="purchaseDate">Purchase Date:</label>
	                        <input type="date" id="purchaseDate" name="purchaseDate">
	                    </div>
	                </form>
	                    <div>
	                        <select class="selectpicker" id="hardwareDDList" name="hardwareDDList"></select>
	                    </div>
	            </div>

	            <div class="modal-footer">
	                <button type ="button" class="btn btn-default" value="Submit" onclick=" validateAddAssetForm()">Submit</button>
	                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	            </div>

	        </div>
	    </div>
	</div>

	<script>

		function startAddAsset()
		{
			getHardwareToAdd();
			$("#addAssetModal").modal("toggle");
		}


		function validateAddAssetForm()
		{
	       
	        var vSN = document.forms["addAssetForm"]["serialNumber"].value;
	        var vPD = document.forms["addAssetForm"]["purchaseDate"].value;
	        

	        var selectedSoftware = (document.getElementById("hardwareDDList"));
	        var selectedsoftwareID = selectedSoftware.value;

	        var today = new Date();
    		var datePD = new Date(vPD);

	        if (vSN == "")
	        {
	            alert("Serial Number Missing");
	        }
	        else if (vPD == "")
	        {
	            alert("Purchase date Missing");
	        }
	        else if ( datePD.getTime() > today.getTime())
	        {
	            alert("Purchase date must be in the past");
	        }
	        else
	        {
	            saveAddAssetForm();
	        }
    	}

    	function saveAddAssetForm()
    	{
	        let myForm = document.getElementById('addAssetForm');
	        let formData = new FormData(myForm);

	        var object = {};
	        formData.forEach(function(value, key)
	        {
	        object[key] = value;
	        });

	        var addAssetData = JSON.stringify(object);
	        console.log(addAssetData);

	        var selectedHardware = (document.getElementById("hardwareDDList"));
	        var selectedHartdwareID = selectedHardware.value;

	        var xmlHttp = new XMLHttpRequest();
	        var theUrl = "http://localhost:8080/asset/add/" + selectedHartdwareID;
	        xmlHttp.open("POST", theUrl);
	        xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

	        xmlHttp.onreadystatechange = function()
	        {
	            if (this.readyState == 4 && this.status == 201)
	            {
	            	document.getElementById("serialNumber").value = "";
	            	document.getElementById("purchaseDate").value = "";
	                alert("Asset Added");
	            }else if (this.readyState == 4 && this.status != 201)
	            {
	                alert("Aset Registration Error");
	            }
	        };

	        xmlHttp.send(addAssetData);
    
    	}


		function getHardwareToAdd()
		{
			let dropdown = document.getElementById('hardwareDDList');
		    dropdown.length = 0;

		    const url = 'http://localhost:8080/hardware';

		    const request = new XMLHttpRequest();
		    request.open('GET', url, true);

		    request.onload = function()
		    {
		    	if (request.status === 200)
		    	{
		    		const data = JSON.parse(request.responseText);
			    	let option;
			    	for (let i = 0; i < data.length; i++)
			    		{
				          option = document.createElement('option');
				          var fullName = data[i].name + " " + data[i].model;
				          option.text = fullName;
				          option.value = data[i].uuid;
				          dropdown.add(option);
			        	}
			        }
			}
			request.onerror = function()
		    {
		    	console.error('An error occurred fetching the JSON from ' + url);
		    };
		    request.send();
		}
	</script>
</body>
</html>