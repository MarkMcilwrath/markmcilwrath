<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="UTF-8" content="width=device-width, initial-scale=1">
        <title>License Assignment</title>

        <link rel="shortcut icon" href="#">
        <script src="https://unpkg.com/@popperjs/core@2"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
        <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>
        <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.0.5/jspdf.plugin.autotable.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round" rel="stylesheet">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
        <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>

        <link rel="stylesheet" href="../../project.css">

        <script>
            $(function(){
                $("#includedContent").load("./adminMenu2.html");
            });
        </script>

</head>
<body>
    <div id="includedContent">
        </div>

        <div class="container">
            <div class="center">
                <div class="menuButtonHolder">
                    <button type="button" class="btn btn-primary btn-lg btn-block"  onclick="startAssignLicense()" >Assign Licenses</button>
                </div>
            </div>
        </div>



<div id="assignSelectLicenseModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Free licenses</h4>
            </div>
            <div class="modal-body">
                <div>
                    <select class="selectpicker" id="aasignLicenseUserDDList" name="aasignLicenseUserDDList"></select>
                </div>
                <br>
                <div>
                    <div id="allFreeLicenses-Table"></div>
                </div>
                <br>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="tagAssignLicenseModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
              
            </div>
            <div class="modal-body">
                <h4>Add Request Tags</h4>
                <div>
                    <form>
                        <div>
                            <label for="assignLicenseLocationTag">First Name:</label>
                            <input type="text" id="assignLicenseLocationTag" name="assignLicenseLocationTag">
                        </div>
                        <div>
                            <label for="assignLicenseDepartmentTag">First Name:</label>
                            <input type="text" id="assignLicenseDepartmentTag" name="assignLicenseDepartmentTag">
                        </div>
                    <form>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default">Confirm</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="confirmAssignLicenseModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
              
            </div>
            <div class="modal-body">
                <h4 id="confirm"></h4>
                <div>
                    
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" onclick="confirmAssinLicense(assignLicenseData)">Confirm</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    var freeLicensesTableData
    var assignLicenseData;

    function startAssignLicense()
        {
            getFreeLicenses();
            getUsersToAssign();
            $("#assignSelectLicenseModal").modal("toggle");
        }

    function getFreeLicenses()
        {
            var xmlHttp = new XMLHttpRequest();
            var theURL = "http://localhost:8080/license/free"
            xmlHttp.onreadystatechange = function()
            {
                if (this.readyState == 4 && this.status == 200)
                {
                 freeLicensesTableData = JSON.parse(this.responseText);
                 buildFreeLicensesTable();
                }
                else
                {

                }
            };
            xmlHttp.open("GET", theURL , true);
            xmlHttp.send();
        }

    function getUsersToAssign()
        {
            let uDropDown = document.getElementById('aasignLicenseUserDDList');
            uDropDown.length = 0;

            const url = 'http://localhost:8080/user';

            const request = new XMLHttpRequest();
            request.open('GET', url, true);

            request.onload = function()
            {
              if (request.status === 200)
              {
                const data = JSON.parse(request.responseText);
                let option;
                for (let i = 0; i < data.length; i++)
                {
                  option = document.createElement('option');
                  option.text = data[i].firstname + " " + data[i].lastname;
                  option.value = data[i].uuid;
                  console.log(option);
                  uDropDown.add(option);
                }
              }
              else
              {}   
                }

            request.onerror = function() {
              console.error('An error occurred fetching the JSON from ' + url);
            };

            request.send();
        }

    function buildFreeLicensesTable()
        {
            table = new Tabulator("#allFreeLicenses-Table",
            {
                data:freeLicensesTableData,
                layout:"fitColumns",
                paginationSize:5,
                movableColumns:true,
                resizableRows:true,
                printAsHtml:true,
                columns:[
                // {title:"ID", field:"uuid"},
                {title:"Software", field:"softwareName", hozAlign:"left"},
                {title:"Version", field:"softwareVersion", hozAlign:"left"},
                {title:"Purchase Date", field:"purchaseDate", hozAlign:"left"},
                {title:"Expiry Date", field:"expiryDate", hozAlign:"left"},
                {title:"License Key", field:"licenseKey", hozAlign:"left"},
                ],
                rowClick:function(e, row)
                {
                    var rowData = row.getData();
                    console.log(rowData);
                    assignLicense(rowData);
                     $("#assignSelectLicenseModal").modal("toggle");
                     $("#tagAssignLicenseModal").modal("toggle");
                     // $("#confirmAssignLicenseModal").modal("toggle");
                }
                }
                );
        }

    function validateAssignLicenseTags()
    {

    }

    function assignLicense(rowData)
        {
            var license_key = rowData.licenseKey;
            var selectedUser = (document.getElementById("aasignLicenseUserDDList"));
            var selectedUserID = selectedUser.value;
            
            var newObject = {};

            newObject['license_key'] = license_key;
            newObject['user_id'] = selectedUserID;

            assignLicenseData = JSON.stringify(newObject);


            document.getElementById("confirm").innerHTML = "Assign: " + rowData.softwareName + " " + rowData.softwareVersion + " [" + rowData.licenseKey + "]";
        }

    function confirmAssinLicense(assignLicenseData)
        {
            var xmlHttp = new XMLHttpRequest();

            var theUrl = "http://localhost:8080/license_assign/add/admin";
            xmlHttp.open("POST", theUrl);
            xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

            xmlHttp.onreadystatechange = function()
            {
                if (this.readyState == 4 && this.status == 201)
                {
                    alert("License Assigned");
                    getFreeLicenses();
                    $("#confirmAssignLicenseModal").modal("toggle");

                }else if (this.readyState == 4 && this.status != 201)
                {
                    alert("Assignment Registration Error");
                }
            };

            xmlHttp.send(assignLicenseData);


        }
            


</script>
</body>
</html>