<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="shortcut icon" href="#">
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>
    <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.0.5/jspdf.plugin.autotable.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>

    <link rel="stylesheet" href="../../../project.css">
</head>
<body>
    
    <div class="container">
        <div class="center">
            <button type="button" class="btn btn-info btn-lg" onclick="startDeleteUser()" >Delete User</button>
        </div>
    </div>

    <div id="selectDeleteUserModal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 id="title" class="modal-title">Select User</h4>
                </div>
                <div class="modal-body">
                    <div id="allUsersToDelete-Table"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

<div id="deleteUserModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="deleteUserTitle" class="modal-title">Delete User</h4>
            </div>
            <div class="modal-footer">
                <button type ="button" class="btn btn-default" onclick="deleteUser()">Delete</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    var userObj;

    var deleteUserID;

    var allUsersToDeleteTableData;


    function startDeleteUser()
    {
        getAllUsersToDelete();
        $("#selectDeleteUserModal").modal("toggle");
    }

    function getAllUsersToDelete()
    {
        var xmlHttp = new XMLHttpRequest();
        var theURL = "http://localhost:8080/user"
        xmlHttp.onreadystatechange = function()
        {
            console.log(this.status);
            if (this.readyState == 4 && this.status == 200)
            {
                var myList1 = (this.responseText);
                var localTD = JSON.parse(myList1);
                allUsersToDeleteTableData = localTD;
                buildDeleteUserTable();
            }
        };
            xmlHttp.open("GET", theURL , true);
            xmlHttp.send();
    }

    function buildDeleteUserTable()
    {
        table = new Tabulator("#allUsersToDelete-Table",
            {
                data:allUsersToDeleteTableData,
                layout:"fitColumns",
                paginationSize:5,
                movableColumns:true,
                resizableRows:true,
                printAsHtml:true,
                printHeader:"<h1>All Users<h1>",
                columns:[
                //{title:"ID", field:"uuid"},
                {title:"First Name", field:"firstname", hozAlign:"left"},
                {title:"Last name", field:"lastname", hozAlign:"left"},
                {title:"Email", field:"email", hozAlign:"left"},
                {title:"Is Admin", field:"admin", hozAlign:"center", formatter:"tickCross"},],
                rowClick:function(e, row)
                {
                    var rowData = row.getData();
                    deleteUserID = rowData.uuid;
                    searchDeleteUserID(deleteUserID);
                }
            }
        );

    }
    
    function searchDeleteUserID(userID)
    {
        
        var xmlHttp = new XMLHttpRequest();
        var theURL = "http://localhost:8080/user/" + userID;

        xmlHttp.onreadystatechange = function()
        {
            console.log(this.status);
            if (this.readyState == 4 && this.status == 200)
            {
                userObj = JSON.parse(this.responseText);

                var emailHold = userObj.email;

                    
                document.getElementById("deleteUserTitle").innerHTML = "Delete User: " + emailHold;
                $("#selectDeleteUserModal").modal("toggle");
                $("#deleteUserModal").modal("toggle")
            }
            else if (this.readyState == 4 && this.status != 200)
            {  
                alert("Error");
            }

        };
        xmlHttp.open("GET", theURL , true);
        xmlHttp.send();
        
    }

    function deleteUser()
    {
        var xmlHttp = new XMLHttpRequest();
        var theURL = "http://localhost:8080/user/" + deleteUserID;
        xmlHttp.onreadystatechange = function()
        {
            if (this.readyState == 4 && this.status == 204)
            {
                getAllUsersToDelete();
                $("#deleteUserModal").modal("toggle");

                alert("User succesfully deleted");
            }
        };
        xmlHttp.open("Delete", theURL , true);
        xmlHttp.send();
    }


</script>

</body>
</html>