<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="shortcut icon" href="#">
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>
    <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.0.5/jspdf.plugin.autotable.js"></script>
    
</head>
<body>

<button type="button" class="btn btn-info btn-lg" >Approve License Request</button>

<div id="allAssignedLicenses" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Unapproved Licneses</h4>
            </div>

            <div class="modal-body">
                
                <br>
                <div id="assigned-Table"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
</body>

<div id="indAssignedLicenses" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Assigned Licneses</h4>
            </div>
            <div class="modal-body">
                <br>
                <div id="indAssigned-Table"></div>
                <br>
                <div id="indassignedTags-Table"></div>
                <div class="wrapper">
                  <button onclick="approveRequest()" class="btn btn-default">Approve</button>
                  <button onclick="rejectRequest()" class="btn btn-default">Reject</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    var unApprovedtableData;
    var unApprovedtableData2;
    
    var approveID;

    function startApprove()
      {
          getOpenAssignments();
          $("#allAssignedLicenses").modal("toggle");
      }

    function getOpenAssignments()
      {
        approveID = null;
          var xmlHttp = new XMLHttpRequest();
          var theURL = "http://localhost:8080/license_assign/approve"
          xmlHttp.onreadystatechange = function()
          {
              console.log(this.status);
              if (this.readyState == 4 && this.status == 200)
              {
               var myList1 = (this.responseText);
               var localTD = JSON.parse(myList1);
               unApprovedtableData = localTD;
               buildUnapprovedTable();
              }
          };
          xmlHttp.open("GET", theURL , true);
          xmlHttp.send();
      }

    function getIndUnapproveAssignment(assignID)
      {
          var xmlHttp = new XMLHttpRequest();
          var theURL = "http://localhost:8080/license_assign/set/" + assignID
          xmlHttp.onreadystatechange = function()
          {
              console.log(this.status);
              if (this.readyState == 4 && this.status == 200)
              {
               var myList1 = (this.responseText);
               var localTD = JSON.parse(myList1);
               unApprovedtableData2 = localTD;
               buildIndUnapprovedTable();
              }
          };
          xmlHttp.open("GET", theURL , true);
          xmlHttp.send();
      }

  

    function buildUnapprovedTable()
      {

          table = new Tabulator("#assigned-Table",
              {
                  data:unApprovedtableData,
                  layout:"fitColumns",
                  paginationSize:5,
                  movableColumns:true,
                  resizableRows:true,
                  printAsHtml:true,
                  printHeader:"<h1>Assiged Licneses<h1>",
                  columns:[
                  // {title:"ID", field:"uuid"},
                  {formatter:"rownum", hozAlign:"center", width:40},
                  {title:"User Email", field:"email", hozAlign:"left"},
                  {title:"Software Name", field:"name", hozAlign:"left"},
                  {title:"Version", field:"version", hozAlign:"left"},
                  {title:"License Key", field:"license_key", hozAlign:"left"},
                  {title:"Assignment Date", field:"assignmentDate", hozAlign:"left"},
                  {title:"Approved?", field:"approved", hozAlign:"center", formatter:"tickCross"},],
                  rowClick:function(e, row)
                  {
                    var rowData = row.getData();
                    approveID = rowData.uuid;
                    getIndUnapproveAssignment(rowData.uuid);
                    $("#allAssignedLicenses").modal("toggle");
                    $("#indAssignedLicenses").modal("toggle");
                  }
              }
          );

      }

    function buildIndUnapprovedTable()
      {

          table2 = new Tabulator("#indAssigned-Table",
              {
                  data:unApprovedtableData2,
                  layout:"fitColumns",
                  paginationSize:5,
                  movableColumns:true,
                  resizableRows:true,
                  printAsHtml:true,
                  printHeader:"",
                  columns:[
                  // {title:"ID", field:"uuid"},
                  {title:"User Email", field:"email", hozAlign:"left"},
                  {title:"Software Name", field:"name", hozAlign:"left"},
                  {title:"Version", field:"version", hozAlign:"left"},
                  {title:"License Key", field:"license_key", hozAlign:"left"},
                  {title:"Assignment Date", field:"assignmentDate", hozAlign:"left"},
                  {title:"Approved?", field:"approved", hozAlign:"center", formatter:"tickCross"},],
                  rowClick:function(e, row)
                  {
                    
                  }
              }
          );

      }

    function approveRequest()
    {
      var xmlHttp = new XMLHttpRequest();
      var theUrl = "http://localhost:8080/license_assign/update/" + approveID;
      xmlHttp.open("PUT", theUrl);
      xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
      xmlHttp.onreadystatechange = function()
      {
        console.log(this.status);
        if (this.readyState == 4 && this.status == 200)
          {
            alert("License Approved");
            getOpenAssignments();
            $("#indAssignedLicenses").modal("toggle");
          }
          else if (this.readyState == 4 && this.status != 200)
          {
            alert("Approval Error");
          }
      };
      xmlHttp.send();
    }

    function rejectRequest()
    {
      var xmlHttp = new XMLHttpRequest();
          var theURL = "http://localhost:8080/license_assign/" + approveID;
          xmlHttp.onreadystatechange = function()
          {
            if (this.readyState == 4 && this.status == 204)
              {
                alert("License unassigned");
                getOpenAssignments();
                $("#indAssignedLicenses").modal("toggle");
              }
              else if (this.readyState == 4 && this.status != 204)
              {
                alert("ERROR");
              }
            };
        xmlHttp.open("Delete", theURL , true);
        xmlHttp.send();
    }

   
</script>
</body>
</html>