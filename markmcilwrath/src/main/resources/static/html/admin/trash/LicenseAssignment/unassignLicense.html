<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="shortcut icon" href="#">
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>
    <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.0.5/jspdf.plugin.autotable.js"></script>
    <style>
      
     </style>
</head>
<body>

<button type="button" class="btn btn-info btn-lg" onclick="startUnassignLicense()">Uassign License</button>

<div id="allAssignedUnassignLicenses" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">All Assigned Licneses</h4>
            </div>

            <div class="modal-body">
                <div id="unassignAssigned-Table"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
</body>


<div id="unassignConfirmModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
               
            </div>
            <div class="modal-body">
                <h4 id="confirmtext"></h4>
                <div>
                    <button id="download-csv" class="btn btn-default" onclick="confirmUnassign(unassignRowData.uuid)">Confirm</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>



</body>
<script>

    var assignedLicensesTableData;

    var unassignRowData;

    var unassigncCommands;

    function startUnassignLicense()
    {
        getAssignments();
        unassigncCommands = document.getElementById("filterCmds");
        unassigncCommands.style.display = ("none");
    }

    function getAssignments()
    {
        var xmlHttp = new XMLHttpRequest();
        var theURL = "http://localhost:8080/license_assign"
        xmlHttp.onreadystatechange = function()
        {
            console.log(this.status);
            if (this.readyState == 4 && this.status == 200)
            {
             var myList1 = (this.responseText);
             var localTD = JSON.parse(myList1);
             assignedLicensesTableData = localTD;
             buildUnassignTable(assignedLicensesTableData);
            }
        };
        xmlHttp.open("GET", theURL , true);
        xmlHttp.send();
    }




    function buildUnassignTable(data)
    {

        table = new Tabulator("#unassignAssigned-Table",
            {
                data:assignedLicensesTableData,
                layout:"fitColumns",
                paginationSize:5,
                movableColumns:true,
                resizableRows:true,
                printAsHtml:true,
                printHeader:"<h1>Assiged Licneses<h1>",
                columns:[
                // {title:"ID", field:"uuid"},
                {formatter:"rownum", hozAlign:"center", width:40},
                {title:"User Email", field:"email", hozAlign:"left"},
                {title:"Software Name", field:"name", hozAlign:"left"},
                {title:"Version", field:"version", hozAlign:"left"},
                {title:"License Key", field:"license_key", hozAlign:"left"},
                {title:"Assignment Date", field:"assignmentDate", hozAlign:"left"},
                {title:"Approved?", field:"approved", hozAlign:"center", formatter:"tickCross"},],
                rowClick:function(e, row)
                {
                  unassignRowData = row.getData();
                  console.log(unassignRowData);
                  $("#allAssignedUnassignLicenses").modal("toggle");
                  unassignLicensePrompt(unassignRowData);
                  $("#unassignConfirmModal").modal("toggle");
                  
                }
            }
        );

    }

    function unassignLicensePrompt(unassignRowData)
        {
            document.getElementById("confirmtext").innerHTML = "Unassign: " + unassignRowData.name + " " + unassignRowData.version + " [" + unassignRowData.license_key + "] from " + unassignRowData.email;
        }

    function confirmUnassign(assignmentID)
        {
          var xmlHttp = new XMLHttpRequest();
          var theURL = "http://localhost:8080/license_assign/" + assignmentID;
          xmlHttp.onreadystatechange = function()
          {
            if (this.readyState == 4 && this.status == 204)
              {
                alert("License unassigned");
                getAssignments();
                $("#unassignConfirmModal").modal("toggle");
              }
              else if (this.readyState == 4 && this.status != 204)
              {
                alert("ERROR");
              }
            };
        xmlHttp.open("Delete", theURL , true);
        xmlHttp.send();
        }



   
</script>
</body>
</html>