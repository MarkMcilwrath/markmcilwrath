<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="UTF-8" content="width=device-width, initial-scale=1">
	    <title>License Assignment</title>

		<link rel="shortcut icon" href="#">
	    <script src="https://unpkg.com/@popperjs/core@2"></script>
	    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
	    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
	    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>
	    <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
	    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>
	    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.0.5/jspdf.plugin.autotable.js"></script>
	    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1">
	    <link href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round" rel="stylesheet">
	    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
	    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
	    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>

	    <link rel="stylesheet" href="../../project.css">

	    <script>
	    	$(function(){
	    		$("#includedContent").load("./adminMenu2.html");
	        });
	    </script>
</head>
<body>
	<div id="includedContent"></div>

		<div class="container">
    		<div class="center">
                <div class="menuButtonHolder">
                    <button type="button" class="btn btn-primary btn-lg btn-block" onclick="startAddLicese()" >Add License</button>
                </div>
            </div>
        </div>

        <div class="container">
    		<div class="center">
                <div class="menuButtonHolder">
                    <button type="button" class="btn btn-primary btn-lg btn-block" onclick="startEdit()">Edit License</button>
                </div>
            </div>
        </div>

        <div class="container">
    		<div class="center">
                <div class="menuButtonHolder">
                    <button type="button" class="btn btn-primary btn-lg btn-block" onclick="startDeleteLicense()">Delete License</button>
                </div>
            </div>
        </div>

        <div class="container">
    		<div class="center">
                <div class="menuButtonHolder">
                    <button type="button" class="btn btn-primary btn-lg btn-block" onclick="startAllLicenses()">All Licenses</button>
                </div>
            </div>
        </div>

	<div id="addLicenseModal" class="modal fade" role="dialog">
	    <div class="modal-dialog">
	        <div class="modal-content">
	            <div class="modal-header">
	            	<h4 class="modal-title">Add License</h4>
	            </div>
	            <div class="modal-body">
	                    <div>
	                        <label for="AddLicenseKey">License Key:</label>
	                        <input type="text" id="AddLicenseKey" name="AddLicenseKey">
	                    </div>
	                    <div>
	                        <label for="addLicensePurchaseDate">Purchase Date:</label>
	                        <input type="date" id="addLicensePurchaseDate" name="addLicensePurchaseDate">
	                    </div>
	                    <div>
	                        <label for="addLicenseExpiryDate">Expiry Date:</label>
	                        <input type="date" id="addLicenseExpiryDate" name="addLicenseExpiryDate">
	                    </div>
	                    <div>
	                        <select class="selectpicker" id="softwareDDList" name="softwareDDList"></select>
	                    </div>
	            </div>
	            <div class="modal-footer">
	                <button type ="button" class="btn btn-default" value="Submit" onclick=" validateAddLicenseForm()">Submit</button>
	                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	            </div>
	        </div>
	    </div>
	</div>

	<div id="selectEditLicenseModal" class="modal fade" role="dialog">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h4 id="title" class="modal-title">Select License</h4>
                  </div>
                      <div class="modal-body">
                          <select class="selectpicker" id="ddList" name="locality"></select>
                      </div>
                  <div class="modal-footer">
                  	<button type="button" class="btn btn-default" data-dismiss="modal" onclick="searchLicenseToEdit()">Edit</button>
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
          </div>
      </div>
  </div>

  <div id="editLicenseModal" class="modal fade" role="dialog">
  	<div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                
                <h4 id="editLicenseTitle" class="modal-title">Edit License</h4>
            </div>
            <div class="modal-body">
                <form id="editLicenseForm" name="editLicenseForm">
                    <div>
                        <label for="purchaseDate">Purchase Date:</label>
                        <input type="date" id="purchaseDate" name="purchaseDate">
                    </div>
                    <div>
                        <label for="expiryDate">Expiry Date:</label>
                        <input type="date" id="expiryDate" name="expiryDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type ="button" class="btn btn-default" onclick="validateEditForm()">Submit Changes </button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    	</div>
	</div>

	<div id="DeleteLicenseModal" class="modal fade" role="dialog">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  
                  <h4 id="title" class="modal-title">Delete License</h4>
                  </div>
                      <div class="modal-body">
                          <select class="selectpicker" id="deleteDDList" name="locality" ></select>
                      </div>
                  <div class="modal-footer">
                  <button type ="button" class="btn btn-default" onclick="confirmDelete()">Delete License</button>
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
          </div>
      </div>
  </div>

  <div id="ConfirmDeleteModal" class="modal fade" role="dialog">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  
                  </div>
                      <div class="modal-body">
                          <p id="Vinfo"></p>
                      </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-default" onclick="deleteLicense()">Delete</button>
                  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
              </div>
          </div>
      </div>
  </div>

  <div id="allLicenseModal" class="modal fade" role="dialog">
	    <div class="modal-dialog modal-dialog-scrollable modal-lg">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h4 class="modal-title">All Licenses</h4>
	            </div>
	            <div class="modal-body">
	                <div class="wrapper">
		                <button id="download-csv" class="btn btn-default">Download CSV</button>
		                <button id="download-json" class="btn btn-default">Download JSON</button>
		                <button id="download-xlsx" class="btn btn-default">Download XLSX</button>
		                <button id="download-pdf" class="btn btn-default">Download PDF</button>
		                <button id="download-html" class="btn btn-default">Download HTML</button>
		                <button id="print-table"class="btn btn-default" >Print Table</button>

	                </div>
	                <br>
	               	<div id="allLicenses-Table"></div>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	            </div>
	        </div>
	    </div>
	</div>

	<script>

	var vLicenseKeyAdd;
	var vPurchaseDateAdd;
	var vExpiryDateAdd;

	var gblEditSoftwareID;

	function startAddLicese()
		{
			getSoftwareToAdd();
			$("#addLicenseModal").modal("toggle");

		}

	function validateAddLicenseForm()
		{
	        vLicenseKeyAdd = document.getElementById("AddLicenseKey").value;
	        vPurchaseDateAdd = document.getElementById("addLicensePurchaseDate").value;
	        vExpiryDateAdd = document.getElementById("addLicenseExpiryDate").value;

	        var selectedSoftware = (document.getElementById("softwareDDList"));
	        var selectedsoftwareID = selectedSoftware.value;

	        var today = new Date();
    		var datePD = new Date(vPurchaseDateAdd);
    		
	        if (vLicenseKeyAdd == "")
	        {
            	alert("License Key Missing");
       	 	}
	        else if (vPurchaseDateAdd == "")
	        {
	            alert("Purchase date Missing");
	        }
	        else if ( datePD.getTime() > today.getTime())
	        {
	            alert("Purchase date must be in the past");
	        }
	        else if (vExpiryDateAdd == "")
	        {
	        	vExpiryDateAdd = null;
	            saveAddLicenseForm();
	        }
	        else 
	        {
	        	var dateED = new Date(vExpiryDateAdd);
	        	if (dateED.getTime() < today.getTime())
	        	{
	        		console.log("");
	        		alert("Expiry Date must be in the future");
	        	}
	        	else
	        	{
	        		saveAddLicenseForm();
	        	}
	        }
	    }	

    function saveAddLicenseForm()
	    	{
		        let myAddLicenseForm;
		        let addLicenseFormData = new FormData(myAddLicenseForm);

		        vLicenseKeyAdd = document.getElementById("AddLicenseKey").value;
		        vPurchaseDateAdd = document.getElementById("addLicensePurchaseDate").value;
		        vExpiryDateAdd = document.getElementById("addLicenseExpiryDate").value;


		        addLicenseFormData.append('licenseKey', vLicenseKeyAdd);
		        addLicenseFormData.append('purchaseDate', vPurchaseDateAdd);
		        addLicenseFormData.append('expiryDate', vExpiryDateAdd);
		        
		        var object = {};
		        addLicenseFormData.forEach(function(value, key)
		        {
		        object[key] = value;
		        });

		        var licenseData = JSON.stringify(object);
		        
		        console.log(licenseData);

		        var selectedSoftware = (document.getElementById("softwareDDList"));
		        var selectedsoftwareID = selectedSoftware.value;

		        console.log(selectedsoftwareID);

		        var xmlHttp = new XMLHttpRequest();
		        var theUrl = "http://localhost:8080/license/add/" + selectedsoftwareID;
		        xmlHttp.open("POST", theUrl);
		        xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

		        xmlHttp.onreadystatechange = function()
		        {
		            if (this.readyState == 4 && this.status == 201)
		            {
		            	document.getElementById("AddLicenseKey").value = "";
		            	document.getElementById("addLicensePurchaseDate").value = "";
		            	document.getElementById("addLicenseExpiryDate").value = "";
		                alert("License Added");
		            }else if (this.readyState == 4 && this.status != 201)
		            {
		                alert("License Registration Error");
		            }
		        };

		        xmlHttp.send(licenseData);
	    
	    	}

	function getSoftwareToAdd()
		{
			let dropdown = document.getElementById('softwareDDList');
		    dropdown.length = 0;

		    const url = 'http://localhost:8080/software';

		    const request = new XMLHttpRequest();
		    request.open('GET', url, true);

		    request.onload = function()
		    {
		    	if (request.status === 200)
		    	{
		    		const data = JSON.parse(request.responseText);
			    	let option;
			    	for (let i = 0; i < data.length; i++)
			    		{
				          option = document.createElement('option');
				          var fullName = data[i].name + " " + data[i].version;
				          option.text = fullName;
				          option.value = data[i].uuid;
				          dropdown.add(option);
			        	}
			    }
			    else
			    {
			    	console.log(request.status);
			    }
			}
			request.onerror = function()
		    {
		    	console.error('An error occurred fetching the JSON from ' + url);
		    };
		    request.send();
		}

	function startEdit()
		{
			dropEditDown();
			$("#selectEditLicenseModal").modal("toggle");
		}

	function searchLicenseToEdit()
		{
		    var selected = (document.getElementById("ddList"));
		    var licenseid = selected.value;
		    gblLicenseKey = licenseid;

		    var xmlHttp = new XMLHttpRequest();
		    var theURL = "http://localhost:8080/license/" + licenseid;

		    xmlHttp.onreadystatechange = function()
		    {
		        if (this.readyState == 4 && this.status == 200)
		        {
		            myObj = JSON.parse(this.responseText);
		            gblEditSoftwareID = (myObj.softwareID);
		            document.getElementById("editLicenseTitle").innerHTML = "Edit License: " + gblLicenseKey;
		           
		            var licensePDHold = myObj.purchaseDate;
		            document.getElementById("purchaseDate").value = licensePDHold;

		            var licenseEDHold = myObj.expiryDate;
		            document.getElementById("expiryDate").value = licenseEDHold;

		            
		            

		            $("#editLicenseModal").modal()
		        }
		        else if (this.readyState == 4 && this.status != 200)
		        {
		        	alert("Error");
		        }
		    };
		    xmlHttp.open("GET", theURL , true);
		    xmlHttp.send();
		}

	function validateEditForm()
		{
		        var vPD = document.forms["editLicenseForm"]["purchaseDate"].value;
		        var vED = document.forms["editLicenseForm"]["expiryDate"].value;

		        var today = new Date();
	    		var datePD = new Date(vPD);
	    		
	    		if (vPD == "")
		        {
		            alert("Purchase date Missing");
		        }
		        else if ( datePD.getTime() > today.getTime())
		        {
		            alert("Purchase date must be in the past");
		        }
		        else if (vED == "")
		        {
		            document.forms["editLicenseForm"]["expiryDate"].value = null;
		            console.log("end null");
		            sendEditLicenseForm();
		        }
		        else 
		        {
		        	var dateED = new Date(vED);
		        	if (dateED.getTime() < today.getTime())
		        	{
		        		alert("Expiry Date must be in the future");
		        	}
		        	else
		        	{
		        		console.log("end date");
		        		sendEditLicenseForm();
		        	}
		        }
		}

	function sendEditLicenseForm()
	    {
	        
	        let myForm = document.getElementById('editLicenseForm');
	        let formData = new FormData(myForm);

	        formData.append('licenseKey', gblLicenseKey);

	        var newObject = {};
	        formData.forEach(function(value, key)
	        {
	        newObject[key] = value;
	        });
	        
	        var licenseData = JSON.stringify(newObject);
	        console.log(licenseData);

	        var xmlHttp = new XMLHttpRequest();
	        var theUrl = "http://localhost:8080/license/update/" + gblEditSoftwareID;
	        xmlHttp.open("PUT", theUrl);
	        xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

	        xmlHttp.onreadystatechange = function()
	        {
	          console.log(this.status);
	            if (this.readyState == 4 && this.status == 200)
	            {
	                alert("License updated");
	                dropEditDown();
	                $("#editLicenseModal").modal("toggle")
	                
	            }else if (this.readyState == 4 && this.status == 500)
	            {
	                alert("License Update Error");
	            }
	        };

	        xmlHttp.send(licenseData);

	      }

  	function dropEditDown()
		{
			let dropdown = document.getElementById('ddList');
		    dropdown.length = 0;

		    const url = 'http://localhost:8080/license';

		    const request = new XMLHttpRequest();
		    request.open('GET', url, true);

		    request.onload = function()
		    {
		    	if (request.status === 200)
		    	{
		    		const data = JSON.parse(request.responseText);
		    		console.log(data);
	        		let option;
	        		for (let i = 0; i < data.length; i++)
	        		{
	        			option = document.createElement('option');
				        var licenseName = data[i].softwareName + " " + data[i].softwareVersion + " " + data[i].licenseKey;
				        option.text = licenseName;
				        option.value = data[i].licenseKey;
				        dropdown.add(option);
				    }
				}
				else 
				{

				}   
			}
			request.onerror = function()
			{
				console.error('An error occurred fetching the JSON from ' + url);
			};
			request.send();
		}

	function startDeleteLicense()
		  {
		    getLicensesForDropDown();
		    $("#DeleteLicenseModal").modal("toggle");

		  }

	function confirmDelete()
		  { 
		    var selected = document.getElementById("deleteDDList");
		    var selectedText = selected.text;
		    console.log(selected.value);
		    document.getElementById("Vinfo").innerHTML = "Are you sure you want to Delete " + selectedText + "?";
		    $("#ConfirmDeleteModal").modal("toggle");
		  }

	function deleteLicense()
	    {
	      var selected = (document.getElementById("deleteDDList"));
	      var licenseID = selected.value;
	      var xmlHttp = new XMLHttpRequest();
	      var theURL = "http://localhost:8080/license/" + licenseID;
	      xmlHttp.onreadystatechange = function()
	      {
	        if (this.readyState == 4 && this.status == 204)
	        {
	        	alert("Software succesfully deleted");
	          	getLicensesForDropDown();
	            $("#ConfirmDeleteModal").modal("hide");
	        } else if (this.readyState == 4 && this.status != 204)
	        {
	          alert("ERROR");
	        }
	      };
	        xmlHttp.open("Delete", theURL , true);
	        xmlHttp.send();
	        
	    }

    function getLicensesForDropDown()
      {
        let dropdown = document.getElementById('deleteDDList');
          dropdown.length = 0;

          const url = 'http://localhost:8080/license';

          const request = new XMLHttpRequest();
          request.open('GET', url, true);

          request.onload = function()
          {
            if (request.status === 200)
            {
              const data = JSON.parse(request.responseText);
              console.log(data);
                let option;
                for (let i = 0; i < data.length; i++)
                {
                  option = document.createElement('option');
                  var licenseName = data[i].softwareName + " " + data[i].softwareVersion + " (" + data[i].licenseKey + ")";
                  option.text = licenseName;
                  option.value = data[i].licenseKey;
                  dropdown.add(option);
              }
          }
          else 
          {

          }   
        }
        request.onerror = function()
        {
          console.error('An error occurred fetching the JSON from ' + url);
        };
        request.send();
      }

    var allLicenseTableData

    function startAllLicenses()
	    {
	        getAllLicenses();
	        $("#allLicenseModal").modal("toggle");
	    }

	function getAllLicenses()
	    {
	        var xmlHttp = new XMLHttpRequest();
	        var theURL = "http://localhost:8080/license"
	        xmlHttp.onreadystatechange = function()
	        {
	            if (this.readyState == 4 && this.status == 200)
	            {
	             allLicenseTableData = JSON.parse(this.responseText);
	             buildTable();
	            }
	            else
	            {
	            	
	            }
	        };
	        xmlHttp.open("GET", theURL , true);
	        xmlHttp.send();
	    }

    function buildTable()
        {
            table = new Tabulator("#allLicenses-Table",
            {
                data:allLicenseTableData,
                layout:"fitColumns",
                paginationSize:5,
                movableColumns:true,
                resizableRows:true,
                printAsHtml:true,
                printHeader:"<h1>All Software<h1>",
                columns:[ 
                // {title:"ID", field:"uuid"},
                {title:"License Key", field:"licenseKey", hozAlign:"left"},
                {title:"Purchase Date", field:"purchaseDate", hozAlign:"left"},
                {title:"Expiry Date", field:"expiryDate", hozAlign:"left"},
                {title:"Software", field:"softwareName", hozAlign:"left"},
                {title:"Version", field:"softwareVersion", hozAlign:"left"},]
                    }
                );

        }

    document.getElementById("download-csv").addEventListener("click", function(){
    table.download("csv", "data.csv");});

    //trigger download of data.json file
    document.getElementById("download-json").addEventListener("click", function(){
        table.download("json", "data.json");});

    //trigger download of data.xlsx file
    document.getElementById("download-xlsx").addEventListener("click", function(){
        table.download("xlsx", "data.xlsx", {sheetName:"My Data"});});

    //trigger download of data.pdf file
    document.getElementById("download-pdf").addEventListener("click", function(){
        table.download("pdf", "data.pdf", {
            orientation:"portrait", //set page orientation to portrait
            title:"Example Report", //add title to report
        });});

    //trigger download of data.html file
    document.getElementById("download-html").addEventListener("click", function(){
    table.download("html", "data.html", {style:true});});

   document.getElementById("print-table").addEventListener("click", function(){
   table.print(false, true);});
	
	</script>
</body>
</html>