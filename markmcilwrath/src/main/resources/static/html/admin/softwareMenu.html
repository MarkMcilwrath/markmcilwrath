<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>
    <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.0.5/jspdf.plugin.autotable.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="../../project.css">

    <script>
    	$(function(){
    		$("#includedContent").load("./adminMenu2.html");
        });
    </script>

</head>
<body>
	<div id="includedContent"></div>

	<div class="container">
    	<div class="center">
            <div class="menuButtonHolder">
            	<button type="button" class="btn btn-primary btn-lg btn-block" onclick="startAddSoftware()">Add Software</button>
            </div>
        </div>
    </div>

    <div class="container">
    	<div class="center">
            <div class="menuButtonHolder">
            	<button type="button" class="btn btn-primary btn-lg btn-block" onclick="startEditSoftware()">Edit Software</button>
            </div>
        </div>
    </div>

    <div class="container">
    	<div class="center">
            <div class="menuButtonHolder">
            	<button type="button" class="btn btn-primary btn-lg btn-block" onclick="startDeleteSoftware()">Delete Software</button>
            </div>
        </div>
    </div>

    <div class="container">
    	<div class="center">
            <div class="menuButtonHolder">
            	<button type="button" class="btn btn-primary btn-lg btn-block" onclick="startAllSoftwares()">All Software</button>
            </div>
        </div>
    </div>

    <div id="addSoftwareModal" class="modal fade" role="dialog">
	    <div class="modal-dialog">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h4 class="modal-title">Add Software</h4>
	            </div>
	            <div class="modal-body">
	                <div>
	                    <label for="addSoftwareName">Name:</label>
	                    <input type="text" id="addSoftwareName" name="addSoftwareName">
	                </div>
	                
	                <div>
	                    <label for="addSoftwareVersion">Version:</label>
	                    <input type="text" id="addSoftwareVersion" name="addSoftwareVersion">
	                </div>
	                <div>
	                    <select class="selectpicker" id="vendorDDList" name="vendorDDList"></select>
	                </div>
	            </div>
	            <div class="modal-footer">
	                <button type ="button" class="btn btn-default" value="Submit" onclick=" validateAddSoftwareForm()">Submit</button>
	                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	            </div>
	        </div>
	    </div>
	</div>

	<div id="selectEditSoftwareModal" class="modal fade" role="dialog">
	      <div class="modal-dialog">
	          <div class="modal-content">
	              <div class="modal-header">
	                  
	                  <h4 id="title" class="modal-title">Select Software</h4>
	                  </div>
	                      <div class="modal-body">
	                          <select class="selectpicker" id="editSoftwareddList" name="locality"></select>
	                      </div>
	                  <div class="modal-footer">
	                    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="searchSoftwareToEdit()">Edit</button>
	                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	              </div>
	          </div>
	      </div>
	</div>

	<div id="editSoftwareModal" class="modal fade" role="dialog">
	    <div class="modal-dialog">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h4 id="title" class="modal-title">Edit Software</h4>
	            </div>
	            <div class="modal-body">
	                    <div>
	                        <label for="editSoftwareName">Name:</label>
	                        <input type="text" id="editSoftwareName" name="editSoftwareName" value="blank">
	                    </div>
	                    <div>
	                        <label for="editSoftwareVersion">Version:</label>
	                        <input type="text" id="editSoftwareVersion" name="editSoftwareVersion" value="blank">
	                    </div>
	            </div>
	            <div class="modal-footer">
	                <button type ="button" class="btn btn-default" onclick="validateEditSoftwareForm()">Submit Changes </button>
	                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	            </div>
	        </div>
	    </div>
	</div>

	<div id="deleteSoftwareModal" class="modal fade" role="dialog">
	    <div class="modal-dialog">
	      <div class="modal-content">

	        <div class="modal-header">
	          
	          <h4 id="title" class="modal-title">Delete Software</h4>
	        </div>

	        <div class="modal-body">
	          <select class="selectpicker" id="deleteSoftwareDDList" name="locality" ></select>  
	        </div>

	        <div class="modal-footer">
	          <button type ="button" class="btn btn-default" onclick="confirmSoftwareDelete()">Delete Software</button>
	          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	        </div>
	      </div>
	    </div>
	  </div>

	<div id="confirmSoftwareDeleteModal" class="modal fade" role="dialog">
	      <div class="modal-dialog">
	          <div class="modal-content">
	              <div class="modal-header">
	                  </div>
	                      <div class="modal-body">
	                          <p id="vDeleteInfo"></p>
	                      </div>
	                  <div class="modal-footer">
	                    <button type="button" class="btn btn-default" onclick="deleteSoftware()">Delete</button>
	                  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
	              </div>
	          </div>
	      </div>
	  </div>

	<div id="allSoftwaresModal" class="modal fade" role="dialog">
	    <div class="modal-dialog modal-dialog-scrollable modal-lg">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h4 class="modal-title">All Software</h4>
	            </div>
	            <div class="modal-body">
	                <div class="wrapper">
	                    <button id="download-csv" class="btn btn-default">Download CSV</button>
	                    <button id="download-json" class="btn btn-default">Download JSON</button>
	                    <button id="download-xlsx" class="btn btn-default">Download XLSX</button>
	                    <button id="download-pdf" class="btn btn-default">Download PDF</button>
	                    <button id="download-html" class="btn btn-default">Download HTML</button>
	                    <button id="print-table"class="btn btn-default" >Print Table</button>
	                </div>
	                <br>
	                <div id="allSoftwares-Table"></div>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	            </div>
	        </div>
	    </div>
	</div>

	<div id="allLicenseModal" class="modal fade" role="dialog">
	    <div class="modal-dialog modal-dialog-scrollable modal-lg">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h4 class="modal-title"></h4>
	            </div>
	            <div class="modal-body">
	                <div class="wrapper">
	                <button id="download-csv" class="btn btn-default">Download CSV</button>
	                <button id="download-json" class="btn btn-default">Download JSON</button>
	                <button id="download-xlsx" class="btn btn-default">Download XLSX</button>
	                    <button id="download-pdf" class="btn btn-default">Download PDF</button>
	                    <button id="download-html" class="btn btn-default">Download HTML</button>
	                    <button id="print-table"class="btn btn-default" >Print Table</button>
	                </div>
	                <br>
	                <div id="license-Table"></div>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	            </div>
	        </div>
	    </div>
	</div>

</body>

<script>
	var vAddSoftwareName;
    var vAddSoftwareVersion; 

    var gblEditSoftwareID;
 	var vEditSoftwareName;
 	var vEditSoftwareVersion;
 	var editSoftwareVendID;

 	var getAllSoftwareTables;
    var getAllSoftwareLicenseTable;


    function startAddSoftware()
        {
            getVendorsToAdd();
            $("#addSoftwareModal").modal("toggle");
        }

    function getVendorsToAdd()
        {
            let dropdown = document.getElementById('vendorDDList');
            dropdown.length = 0;

            const url = 'http://localhost:8080/vendor';
            const request = new XMLHttpRequest();
            request.open('GET', url, true);

            request.onload = function(){
                if (request.status === 200) {
                    const data = JSON.parse(request.responseText);
                    let option;
                    for (let i = 0; i < data.length; i++) {
                      option = document.createElement('option');
                      option.text = data[i].name;
                      option.value = data[i].uuid;
                      dropdown.add(option);
                    }
                   } else {
                  }   
                }

                request.onerror = function() {
                  console.error('An error occurred fetching the JSON from ' + url);
                };

                request.send();
        }

	function validateAddSoftwareForm()
        {
            vAddSoftwareName = document.getElementById("addSoftwareName").value;
            vAddSoftwareVersion = document.getElementById("addSoftwareVersion").value;

            if (vAddSoftwareName == "")
            {
                alert("Name Missing");
                console.log("false");
            }
            else if (vAddSoftwareVersion == "")
            {
                alert("Version Missing");
                console.log("false");
            }
            else
            {
                console.log("true");
                saveAddSoftwareForm();
            }
        }

    function saveAddSoftwareForm()
        {
            let myAddSoftwareForm;
            let addSoftwareFormData = new FormData(myAddSoftwareForm);

            let selected = (document.getElementById("vendorDDList"));
            var vendorID = selected.value;

            addSoftwareFormData.append('name', vAddSoftwareName);
            addSoftwareFormData.append('version', vAddSoftwareVersion)

            var object = {};
            addSoftwareFormData.forEach(function(value, key)
            {
            object[key] = value;
            });

            var addSoftwareData = JSON.stringify(object);
            console.log(addSoftwareData);

            var xmlHttp = new XMLHttpRequest();
            var theUrl = "http://localhost:8080/software/add/" + vendorID;

            xmlHttp.open("POST", theUrl);
            xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

            xmlHttp.onreadystatechange = function()
            {
                if (this.readyState == 4 && this.status == 201)
                {
                    document.getElementById("addSoftwareVersion").value = "";
                    document.getElementById("addSoftwareName").value = "";
                    alert("Software Added");
                }else if (this.readyState == 4 && this.status != 201)
                {
                    alert("Software Registration Error");
                }
            };

            xmlHttp.send(addSoftwareData);
        
        }

    function startEditSoftware()
	    {
	      getSoftwaresDropDown();
	      $("#selectEditSoftwareModal").modal("toggle");
	    }

  	function getSoftwaresDropDown()
	    {
	      let dropdown = document.getElementById('editSoftwareddList');
	      dropdown.length = 0;

	      dropdown.selectedIndex = 0;

	      const url = 'http://localhost:8080/software';

	      const request = new XMLHttpRequest();
	      request.open('GET', url, true);

	      request.onload = function() {
	        if (request.status === 200) {
	          const data = JSON.parse(request.responseText);
	          let option;
	          for (let i = 0; i < data.length; i++) {
	            option = document.createElement('option');
	            var fullName = data[i].name + " " + data[i].version;
	            option.text = fullName;
	            option.value = data[i].uuid;
	            dropdown.add(option);
	          }
	         } else {
	        }   
	      }

	    request.onerror = function() {
	      console.error('An error occurred fetching the JSON from ' + url);
	    };

	    request.send();
	   }

  	function searchSoftwareToEdit()
	    {
	      var selected = (document.getElementById("editSoftwareddList"));
	      var softwareID = selected.value;
	      gblEditSoftwareID = softwareID;

	      var xmlHttp = new XMLHttpRequest();
	      var theURL = "http://localhost:8080/software/" + softwareID;

	      xmlHttp.onreadystatechange = function()
	      {
	          if (this.readyState == 4 && this.status == 200)
	            {

	              myObj = JSON.parse(this.responseText);
	              console.log(myObj);
	              var nameHold = myObj.name;
	              editSoftwareVendID = myObj.vendorID;
	              document.getElementById("editSoftwareName").value = nameHold;
	              var versionHold = myObj.version;
	              document.getElementById("editSoftwareVersion").value = versionHold;
	              
	              $("#editSoftwareModal").modal()
	              }
	              else if (this.readyState == 4 && this.status != 200)
	              { 
	              alert("Error");
	              }
	          };
	          xmlHttp.open("GET", theURL , true);
	          xmlHttp.send();
	        }

  	function validateEditSoftwareForm()
	    {

	      vEditSoftwareName = document.getElementById("editSoftwareName").value;
	      vEditSoftwareVersion = document.getElementById("editSoftwareVersion").value;

	        if (vEditSoftwareName == "")
	        {
	          alert("Name Missing");
	        }
	        else if (vEditSoftwareVersion == "")
	        {
	          alert("Version Missing");
	        }
	        else
	        {
	          sendEditSoftwareForm();
	        }
	    }

  	function sendEditSoftwareForm()
	    {
	        
	        let myEditSoftwareForm;
	        let editSoftwareformData = new FormData(myEditSoftwareForm);

	        editSoftwareformData.append('name', vEditSoftwareName);
	        editSoftwareformData.append('version', vEditSoftwareVersion);
	        editSoftwareformData.append('uuid', gblEditSoftwareID);


	        var newObject = {};
	        editSoftwareformData.forEach(function(value, key)
	        {
	        newObject[key] = value;
	        });
	        
	        var editSoftwareData = JSON.stringify(newObject);
	        console.log(editSoftwareData);

	        var xmlHttp = new XMLHttpRequest();
	        var theUrl = "http://localhost:8080/software/update/" + editSoftwareVendID;
	        xmlHttp.open("PUT", theUrl);
	        xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

	        xmlHttp.onreadystatechange = function()
	        {
	          console.log(this.status);
	            if (this.readyState == 4 && this.status == 200)
	            {
	                alert("Software updated");
	                getSoftwaresDropDown();
	                $("#editSoftwareModal").modal("toggle")
	                
	            }else if (this.readyState == 4 && this.status == 500)
	            {
	                alert("Software Update Error");
	            }
	        };

	        xmlHttp.send(editSoftwareData);

	      }

	function startDeleteSoftware()
	  {
	    getSoftwaresToDelete();
	    $("#deleteSoftwareModal").modal("toggle");
	  }

  	function getSoftwaresToDelete()
	      {
	        var dropdown = document.getElementById('deleteSoftwareDDList');
	        dropdown.length = 0;

	        const url = 'http://localhost:8080/software';

	        const request = new XMLHttpRequest();
	        request.open('GET', url, true);

	        request.onload = function() {
	          if (request.status === 200) {
	            const data = JSON.parse(request.responseText);
	            let option;
	            for (let i = 0; i < data.length; i++) {
	              option = document.createElement('option');
	              var fullName = data[i].name + " " + data[i].version;
	              option.text = fullName;
	              option.value = data[i].uuid;
	              dropdown.add(option);
	            }
	           } else {
	          }   
	        }

	        request.onerror = function() {
	          console.error('An error occurred fetching the JSON from ' + url);
	        };

	        request.send();
	      }

  	function confirmSoftwareDelete()
		  { 
		    var selected = document.getElementById("deleteSoftwareDDList");
		    var selectedText = selected.options[selected.selectedIndex].text;
		    console.log(selectedText);
		    document.getElementById("vDeleteInfo").innerHTML = "Are you sure you want to Delete " + selectedText + "?";
		    $("#confirmSoftwareDeleteModal").modal();
		  }

  	function deleteSoftware()
	    {
	      var selected = (document.getElementById("deleteSoftwareDDList"));
	      softwareID = selected.value;
	      var xmlHttp = new XMLHttpRequest();
	      var theURL = "http://localhost:8080/software/" + softwareID;
	      xmlHttp.onreadystatechange = function()
	      {
	        if (this.readyState == 4 && this.status == 204)
	        {
	        	alert("Software succesfully deleted");
	          	getSoftwaresToDelete();
	            $("#confirmSoftwareDeleteModal").modal("hide");
	        } else if (this.readyState == 4 && this.status != 204)
	        {
	          alert("ERROR");
	        }
	      };
	        xmlHttp.open("Delete", theURL , true);
	        xmlHttp.send();
	        
	    }

	function startAllSoftwares()
		{
	        $("#allSoftwaresModal").modal("toggle");

	        getAllSoftwares();
	    }

	function getAllSoftwares()
	    {

	        var xmlHttp = new XMLHttpRequest();
	        var theURL = "http://localhost:8080/software"
	        xmlHttp.onreadystatechange = function()
	        {
	            if (this.readyState == 4 && this.status == 200)
	            {
	             getAllSoftwareTables = JSON.parse(this.responseText);
	             buildAllSoftwareTable();
	            }
	            else
	            {
	            	
	            }
	        };
	        xmlHttp.open("GET", theURL , true);
	        xmlHttp.send();
	    }

	function buildAllSoftwareTable()
        {
            table = new Tabulator("#allSoftwares-Table",
            {
                data:getAllSoftwareTables,
                layout:"fitColumns",
                paginationSize:5,
                movableColumns:true,
                resizableRows:true,
                printAsHtml:true,
                printHeader:"<h1>All Software<h1>",
                columns:[ 
                // {title:"ID", field:"uuid"},
                {title:"Name", field:"name", hozAlign:"left"},
                {title:"Version", field:"version", hozAlign:"left"},
                {title:"Vendor", field:"vendorName", hozAlign:"left"},],
                rowClick:function(e, row)
                    {
                        var rowData = row.getData();
                        getLicenses(rowData.uuid);
                        $("#allSoftwaresModal").modal("toggle");
                        $("#allLicenseModal").modal("toggle");
                    }
                    }
                );

        }

    function getLicenses(softwareID)
        {
            var xmlHttp = new XMLHttpRequest();
            var theURL = "http://localhost:8080/license/software/" + softwareID;
            xmlHttp.onreadystatechange = function()
            {
                if (this.readyState == 4 && this.status == 200)
                {
                getAllSoftwareLicenseTable = JSON.parse(this.responseText);
                 buildLicenseTable();
                }
                else
                {
                    
                }
            };
            xmlHttp.open("GET", theURL , true);
            xmlHttp.send();
        }

    function buildLicenseTable()
        {
            table = new Tabulator("#license-Table",
            {
                data:getAllSoftwareLicenseTable,
                layout:"fitColumns",
                paginationSize:5,
                movableColumns:true,
                resizableRows:true,
                printAsHtml:true,
                printHeader:"<h1>All Software<h1>",
                columns:[ 
                // {title:"ID", field:"uuid"},
                {title:"License Key", field:"licenseKey", hozAlign:"left"},
                {title:"Purchase Date", field:"purchaseDate", hozAlign:"left"},
                {title:"Expiry Date", field:"expiryDate", hozAlign:"left"},
                ],
                rowClick:function(e, row)
                    {
                        
                    }
                    }
                );

        }

    
    document.getElementById("download-csv").addEventListener("click", function(){
    table.download("csv", "data.csv");});

    //trigger download of data.json file
    document.getElementById("download-json").addEventListener("click", function(){
        table.download("json", "data.json");});

    //trigger download of data.xlsx file
    document.getElementById("download-xlsx").addEventListener("click", function(){
        table.download("xlsx", "data.xlsx", {sheetName:"My Data"});});

    //trigger download of data.pdf file
    document.getElementById("download-pdf").addEventListener("click", function(){
        table.download("pdf", "data.pdf", {
            orientation:"portrait", //set page orientation to portrait
            title:"Example Report", //add title to report
        });});

    //trigger download of data.html file
    document.getElementById("download-html").addEventListener("click", function(){
        table.download("html", "data.html", {style:true});});

    document.getElementById("print-table").addEventListener("click", function(){
   table.print(false, true);});
</script>
</html>