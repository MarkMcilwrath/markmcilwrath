<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>
    <style>
        .wrapper{
              align-items: center;
              justify-content: center;
              margin-top: 5px;
              margin-bottom: : 5px;
              display: flex;
              width: 100%;
                    }
        .btn-default {
                margin-right: 5px;
                margin-left: 5px;
                }
            .container{
            height: 70px;
            position: relative;}
        .center {
            margin: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);}
    </style>
    </style>
</head>
<body>

	<div class="container">
        <div class="center">
            <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#allLicenseModal" onclick="start()" >Assign Asset</button>
        </div>
    </div>

    <div id="allAssetsModal" class="modal fade" role="dialog">
	    <div class="modal-dialog modal-dialog-scrollable modal-lg">
	        <div class="modal-content">
	            <div class="modal-header">
	                <button type="button" class="close" data-dismiss="modal">&times;</button>
	                <h4 class="modal-title">Free Assets</h4>
	            </div>
	            <div class="modal-body">
	                <div>
	                    <select class="selectpicker" id="userDdList" name="userDdList"></select>
	                </div>
	                <div>
	                    <div id="allAssets-Table"></div>
	                </div>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	            </div>
      	  </div>
   	 	</div>
	</div>

	<div id="confirmModal" class="modal fade" role="dialog">
	    <div class="modal-dialog modal-dialog-scrollable modal-lg">
	        <div class="modal-content">
	            <div class="modal-header">
	                <button type="button" class="close" data-dismiss="modal">&times;</button>
	            </div>
	            <div class="modal-body">
	                <h4 id="confirm"></h4>
	                <div>
	                    <button class="btn btn-default" onclick="confirm()">Confirm</button>
	                </div>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	            </div>
	        </div>
	    </div>
	</div>

</body>
<script>
	var tableData
    var table;
    var assignData;

    function start()
        {
            getAssets();
            getUsers();
            $("#allAssetsModal").modal("toggle");
        }

    function getAssets()
	    {
	        var xmlHttp = new XMLHttpRequest();
	        var theURL = "http://localhost:8080/asset/free"
	        xmlHttp.onreadystatechange = function()
	        {
	            if (this.readyState == 4 && this.status == 200)
	            {
	             tableData = JSON.parse(this.responseText);
	             buildTable();
	            }
	            else
	            {

	            }
	        };
	        xmlHttp.open("GET", theURL , true);
	        xmlHttp.send();
	    }

	function getUsers()
        {
            let uDropDown = document.getElementById('userDdList');
            uDropDown.length = 0;

            const url = 'http://localhost:8080/user';

            const request = new XMLHttpRequest();
            request.open('GET', url, true);

            request.onload = function()
            {
              if (request.status === 200)
              {
                const data = JSON.parse(request.responseText);
                let option;
                for (let i = 0; i < data.length; i++)
                {
                  option = document.createElement('option');
                  option.text = data[i].firstname + " " + data[i].lastname;
                  option.value = data[i].uuid;
                  uDropDown.add(option);
                }
              }
              else
              {}   
                }

            request.onerror = function() {
              console.error('An error occurred fetching the JSON from ' + url);
            };

            request.send();
        }

    function selectUser()
        {
            tbl.style.display = "table";
        }


    function rebuildTable()
        {
            table.redraw();
        }

    function buildTable()
        {
            table = new Tabulator("#allAssets-Table",
            {
                data:tableData,
                layout:"fitColumns",
                paginationSize:5,
                movableColumns:true,
                resizableRows:true,
                printAsHtml:true,
                columns:[
                // {title:"ID", field:"assetTag"},
                {title:"Name", field:"name", hozAlign:"left"},
                {title:"Model", field:"model", hozAlign:"left"},
                {title:"Purchase Date", field:"purchaseDate", hozAlign:"left"},
                {title:"Serial Number", field:"serialNumber", hozAlign:"left"},
                ],
                rowClick:function(e, row)
                {
                    var rowData = row.getData();
                    assignAsset(rowData);
                    
                    $("#allLicenseModal").modal("toggle");
                    $("#confirmModal").modal("toggle");
                }
                }
                );
        }

        function assignAsset(rowData)
        {
            var asset_tag = rowData.assetTag;

            var selectedUser = (document.getElementById("userDdList"));
            var selectedUserID = selectedUser.value;

            var newObject = {};

            newObject['assetTag'] = asset_tag;
            newObject['userID'] = selectedUserID;

            assignData = JSON.stringify(newObject);
            console.log(assignData);

            // document.getElementById("confirm").innerHTML = "Assign: " + rowData.name + " " + rowData.model + " [" + rowData.serialNumber + "]"
        }

        function confirm()
        {
            var xmlHttp = new XMLHttpRequest();

            var theUrl = "http://localhost:8080/asset_assign/add/admin";
            xmlHttp.open("POST", theUrl);
            xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

            xmlHttp.onreadystatechange = function()
            {
            	console.log(this.status);
                if (this.readyState == 4 && this.status == 201)
                {
                    alert("License Assigned");
                    getAssets();
                    $("#confirmModal").modal("toggle");

                }else if (this.readyState == 4 && this.status != 201)
                {
                    alert("Assignment Registration Error");
                }
            };
            console.log(assignData);
            xmlHttp.send(assignData);


        }
</script>
</html>