<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>
<body onload="dropDown()">
	<button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#addLicenseModal">Add License</button>

	<div id="addLicenseModal" class="modal fade" role="dialog">
	    <div class="modal-dialog">
	        <div class="modal-content">
	            <div class="modal-header">
	            	<button type="button" class="close" data-dismiss="modal">&times;</button>
	            	<h4 class="modal-title">Add License</h4>
	            </div>
	            <div class="modal-body">
	                <form id="addLicenseForm" name="addLicenseForm">
	                    <div>
	                        <label for="licenseKey">License Key:</label>
	                        <input type="text" id="licenseKey" name="licenseKey">
	                    </div>
	                    <div>
	                        <label for="purchaseDate">Purchase Date:</label>
	                        <input type="date" id="purchaseDate" name="purchaseDate">
	                    </div>
	                    <div>
	                        <label for="expiryDate">Expiry Date:</label>
	                        <input type="date" id="expiryDate" name="expiryDate">
	                    </div>
	                </form>
	                    <div>
	                        <select class="selectpicker" id="softwareDDList" name="softwareDDList"></select>
	                    </div>
	            </div>
	            <div class="modal-footer">
	                <button type ="button" class="btn btn-default" value="Submit" onclick=" validateForm()">Submit</button>
	                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	            </div>
	        </div>
	    </div>
	</div>

	<script>
		function validateForm()
		{
	        var vLK = document.forms["addLicenseForm"]["licenseKey"].value;
	        var vPD = document.forms["addLicenseForm"]["purchaseDate"].value;
	        var vED = document.forms["addLicenseForm"]["expiryDate"].value;

	        var selectedSoftware = (document.getElementById("softwareDDList"));
	        var selectedsoftwareID = selectedSoftware.value;

	        var today = new Date();
    		var datePD = new Date(vPD);
    		
	        if (vLK == "")
	        {
            	alert("License Key Missing");
       	 	}
	        else if (vPD == "")
	        {
	            alert("Purchase date Missing");
	        }
	        else if ( datePD.getTime() > today.getTime())
	        {
	            alert("Purchase date must be in the past");
	        }
	        else if (vED == "")
	        {
	            document.forms["addLicenseForm"]["expiryDate"].value = null;
	            console.log("end null");
	            saveForm();
	        }
	        else 
	        {
	        	var dateED = new Date(vED);
	        	if (dateED.getTime() < today.getTime())
	        	{
	        		console.log("");
	        		alert("Expiry Date must be in the future");
	        	}
	        	else
	        	{
	        		saveForm();
	        	}
	        }
	    }	

    	function saveForm()
    	{
	        let myForm = document.getElementById('addLicenseForm');
	        let formData = new FormData(myForm);

	        var object = {};
	        formData.forEach(function(value, key)
	        {
	        object[key] = value;
	        });

	        var licenseData = JSON.stringify(object);
	        
	        console.log(licenseData);

	        var selectedSoftware = (document.getElementById("softwareDDList"));
	        var selectedsoftwareID = selectedSoftware.value;

	        console.log(selectedsoftwareID);

	        var xmlHttp = new XMLHttpRequest();
	        var theUrl = "http://localhost:8080/license/add/" + selectedsoftwareID;
	        xmlHttp.open("POST", theUrl);
	        xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

	        xmlHttp.onreadystatechange = function()
	        {
	            if (this.readyState == 4 && this.status == 201)
	            {
	            	document.getElementById("licenseKey").value = "";
	            	document.getElementById("purchaseDate").value = "";
	            	document.getElementById("expiryDate").value = "";
	                alert("License Added");
	            }else if (this.readyState == 4 && this.status != 201)
	            {
	                alert("License Registration Error");
	            }
	        };

	        xmlHttp.send(licenseData);
    
    	}


		function dropDown()
		{
			let dropdown = document.getElementById('softwareDDList');
		    dropdown.length = 0;

		    const url = 'http://localhost:8080/software';

		    const request = new XMLHttpRequest();
		    request.open('GET', url, true);

		    request.onload = function()
		    {
		    	if (request.status === 200)
		    	{
		    		const data = JSON.parse(request.responseText);
			    	let option;
			    	for (let i = 0; i < data.length; i++)
			    		{
				          option = document.createElement('option');
				          var fullName = data[i].name + " " + data[i].version;
				          option.text = fullName;
				          option.value = data[i].uuid;
				          dropdown.add(option);
			        	}
			    }
			    else
			    {
			    	console.log(request.status);
			    }
			}
			request.onerror = function()
		    {
		    	console.error('An error occurred fetching the JSON from ' + url);
		    };
		    request.send();
		}
	</script>
</body>
</html>