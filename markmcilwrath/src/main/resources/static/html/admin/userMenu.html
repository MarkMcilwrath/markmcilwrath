<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8" content="width=device-width, initial-scale=1">
    <title>User</title>

	<link rel="shortcut icon" href="#">
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>
    <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.0.5/jspdf.plugin.autotable.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>

    <link rel="stylesheet" href="../../project.css">

    <script>
    	$(function(){
    		$("#includedContent").load("./adminMenu2.html");
        });
    </script>
</head>
<body>
		<div id="includedContent">
		</div>

		<div class="container">
    		<div class="center">
                <div class="menuButtonHolder">
                    <button id="addUserBtn" type="button" class="btn btn-primary btn-lg btn-block" onclick="startAddUser()">Add User</button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="center">
                <div class="menuButtonHolder">
                     <button type="button" class="btn btn-primary btn-lg btn-block" onclick="startEditUser()">Edit User</button>
                </div>
            </div>
        </div>

        <div class="container">
    		<div class="center">
                <div class="menuButtonHolder">
                    <button id="delUserBtn" type="button" class="btn btn-primary btn-lg btn-block" onclick="startDeleteUser()">Delete User</button>
                </div>
            </div>
        </div>

        <div class="container">
    		<div class="center">
                <div class="menuButtonHolder">
                   <button id="allUserBtn" type="button" class="btn btn-primary btn-lg btn-block" onclick="startGetAllUsers()">All Users</button>
                </div>
            </div>
        </div>


    <div id="addUserModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Add User</h4>
                </div>
                <div class="modal-body">
                        <div>
                            <label for="addUserFirstName">First Name:</label>
                            <input type="text" id="addUserFirstName" name="addUserFirstName">
                        </div>
                        <div>
                            <label for="addUserLastName">Last Name:</label>
                            <input type="text" id="addUserLastName" name="addUserLastName">
                        </div>
                        <div>
                            <label for="addUserEmail"> Email:</label>
                            <input type="addUserEmail" id="addUserEmail" name="addUserEmail">
                        </div>
                        <div>
                            <label for="addUserAdmin"> Admin:</label>
                            <input type="checkbox" name="addUserAdmin" id="addUserAdmin" value="false">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type ="button" class="btn btn-default" value="Submit" onclick=" validateAddUserForm()">Submit</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="selectEditUserModal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 id="title" class="modal-title">Select User</h4>
                </div>
                <div class="modal-body">
                    <div id="allUsersToEdit-Table"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editUserModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 id="editUserTitle" class="modal-title">Edit User</h4>
                </div>
                <div class="modal-body">
                        <div>
                            <label for="EditUserFirstName">First Name: </label>
                            <input type="text" id="editUserFirstName" name="editUserFirstName" value="blank">
                        </div>
                        <div>
                            <label for="EditUserLastName">last Name: </label>
                            <input type="text" id="editUserLastName" name="editUserLastName" value="blank">
                        </div>
                        <div>
                            <label for="EditUserAdmin">Admin: </label>
                            <input type="checkbox" name="editUserAdmin" id="editUserAdmin">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type ="button" class="btn btn-default" onclick="validateEditUserForm()">Submit Changes</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="searchDeleteUserModal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">

                    <h4 class="modal-title">Delete user: Search email</h4>
                </div>
                <div class="modal-body">
                    <form id="userEmailForm" name="userEmailForm">
                        <div>
                            <label for="userEmail">Email: </label>
                            <input type="email" id="userEmail" name="userEmail">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" onclick="searchIDtoDelete()" >Search</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal" >Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="ConfirmDeleteModal" class="modal fade" role="dialog">
          <div class="modal-dialog">
              <div class="modal-content">
                  <div class="modal-header">
                      </div>
                          <div class="modal-body">
                              <p id="VDelinfo"></p>
                          </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" onclick="deleteUser()">Delete</button>
                      <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                  </div>
              </div>
          </div>
      </div>

      <div id="allUsersModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">All User</h4>
            </div>
            <div class="modal-body">
                <div class="wrapper">
                    <button id="download-csv" class="btn btn-default">Download CSV</button>
                    <button id="download-json" class="btn btn-default">Download JSON</button>
                    <button id="download-xlsx" class="btn btn-default">Download XLSX</button>
                    <button id="download-pdf" class="btn btn-default">Download PDF</button>
                    <button id="download-html" class="btn btn-default">Download HTML</button>
                    <button id="print-table"class="btn btn-default" >Print Table</button>
                </div>
                <br>
                <div id="allUsers-Table"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="userInfoModal" class="modal fade" role="dialog">
      <div class="modal-dialog modal-dialog-scrollable modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <h4 class="usermodal-title">User Information</h4>
              </div>
              <div class="modal-body">
                <div id="userData"></div>
                  <br>
                  <h4>Licenses</h4>
                  <div id="userLicense-Table"></div>
                  <br>
                  <h4>Assets</h4>
                  <div id="userAsset-Table"></div>
              </div>

              <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
          </div>
      </div>
  </div>


</body>

<script>

    var vAddUserFirstname;
    var vAddUserLastname;
    var vAddUserEmail;

    var userObj;
    var allUsersToEditTableData;
    var vEditUserFirstname;
    var vEditUserLastname;

    function startAddUser()
        {
            $("#addUserModal").modal("toggle");
        }

    function validateAddUserForm()
        {
            vAddUserFirstname = document.getElementById("addUserFirstName").value;
            vAddUserLastname = document.getElementById("addUserLastName").value;
            vAddUserEmail = document.getElementById("addUserEmail").value;

            if (vAddUserFirstname == "")
            {
                alert("First name missing");
                console.log("false");
            }
            else if (vAddUserLastname == "")
            {
                alert("Last name missing");
                console.log("false");
            }
            else if (vAddUserEmail == "")
            {
                alert("Email missing");
                console.log("false");
            }
            else
            {
                console.log("true");
                saveAddUserForm();
            }
        }

    function saveAddUserForm()
        {

        let myAddUserForm;
        let addUserFormData = new FormData(myAddUserForm);

        addUserFormData.append('firstname', vAddUserFirstname);
        addUserFormData.append('lastname', vAddUserLastname);
        addUserFormData.append('email', vAddUserEmail);


        var checkBox = document.getElementById("addUserAdmin");
        if (checkBox.checked == true)
            {
            addUserFormData.append('admin', "true");
            }
            else
            {
            addUserFormData.append('admin', "false");
            }

        var object = {};
        addUserFormData.forEach(function(value, key)
        {
        object[key] = value;
        });
        var userData = JSON.stringify(object);
        console.log(userData);

        var xmlHttp = new XMLHttpRequest();
        var theUrl = "http://localhost:8080/user/add";
        xmlHttp.open("POST", theUrl);
        xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

        xmlHttp.onreadystatechange = function()
            {
                if (this.readyState == 4 && this.status == 201)
                {
                    alert("User Added");
                    document.getElementById("addUserFirstName").value = "";
                    document.getElementById("addUserLastName").value = "";
                    document.getElementById("addUserEmail").value = "";
                }else if (this.readyState == 4 && this.status != 201)
                {
                    alert("User Registration Error");
                }
            };
        xmlHttp.send(userData);
        }

    function startEditUser()
        {
            getAllUsersToEdit();
            $("#selectEditUserModal").modal("toggle");
        }

    function getAllUsersToEdit()
        {
            var xmlHttp = new XMLHttpRequest();
            var theURL = "http://localhost:8080/user"
            xmlHttp.onreadystatechange = function()
            {
                console.log(this.status);
                if (this.readyState == 4 && this.status == 200)
                {
                    var myList1 = (this.responseText);
                    var localTD = JSON.parse(myList1);
                    allUsersToEditTableData = localTD;
                    buildEditUserTable();
                }
            };
                xmlHttp.open("GET", theURL , true);
                xmlHttp.send();
        }

    function buildEditUserTable()
        {
            table = new Tabulator("#allUsersToEdit-Table",
                {
                    data:allUsersToEditTableData,
                    layout:"fitColumns",
                    paginationSize:5,
                    movableColumns:true,
                    resizableRows:true,
                    printAsHtml:true,
                    printHeader:"<h1>All Users<h1>",
                    columns:[
                    //{title:"ID", field:"uuid"},
                    {title:"First Name", field:"firstname", hozAlign:"left"},
                    {title:"Last name", field:"lastname", hozAlign:"left"},
                    {title:"Email", field:"email", hozAlign:"left"},
                    {title:"Is Admin", field:"admin", hozAlign:"center", formatter:"tickCross"},],
                    rowClick:function(e, row)
                    {
                        var rowData = row.getData();
                        var editUserID = rowData.uuid;
                        searchEditUserID(editUserID);
                    }
                }
            );
        }
    
    function searchEditUserID(userID)
        {
            
            var xmlHttp = new XMLHttpRequest();
            var theURL = "http://localhost:8080/user/" + userID;

            xmlHttp.onreadystatechange = function()
            {
                console.log(this.status);
                if (this.readyState == 4 && this.status == 200)
                {
                    userObj = JSON.parse(this.responseText);
                    var fNameHold = userObj.firstname;
                    var lNameHold = userObj.lastname;
                    var emailHold = userObj.email;
                    var adminHold = userObj.admin;
                        
                    document.getElementById("editUserFirstName").value = fNameHold;
                    document.getElementById("editUserLastName").value = lNameHold;
                    document.getElementById("editUserTitle").innerHTML = "Edit User: " + emailHold;

                    if (adminHold == true)
                    {
                        document.getElementById("editUserAdmin").checked = true;
                    }
                    
                        
                    $("#editUserModal").modal("toggle")
                }
                else if (this.readyState == 4 && this.status != 200)
                {  
                    alert("Error");
                }

            };
            xmlHttp.open("GET", theURL , true);
            xmlHttp.send();
            
        }

    function validateEditUserForm()
        {
             vEditUserFirstname = document.getElementById("editUserFirstName").value;
             vEditUserLastname = document.getElementById("editUserLastName").value;

            if (vEditUserFirstname == "")
            {
                alert("First name missing");
                console.log("false");
            }
            else if (vEditUserLastname == "")
            {
                alert("Last name missing");
            }
            else
            {
                saveEditUserForm();
            }
        }

    function saveEditUserForm()
        {
            let myEditUserForm;
            let editUserFormData = new FormData(myEditUserForm);
            
            editUserFormData.append('firstname', vEditUserFirstname);
            editUserFormData.append('lastname', vEditUserLastname);
            editUserFormData.append('email', userObj.email);

            var checkBox = document.getElementById("editUserAdmin");
            if (checkBox.checked == true)
                {
                editUserFormData.append('admin', "true");
                }
                else
                {
                editUserFormData.append('admin', "false");
                }
            var object = {};
            editUserFormData.forEach(function(value, key)
            {
            object[key] = value;
            });
            var editUserData = JSON.stringify(object);

            console.log(editUserData);

            var xmlHttp = new XMLHttpRequest();
            var theUrl = "http://localhost:8080/user/update";
            xmlHttp.open("PUT", theUrl);
            xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

            xmlHttp.onreadystatechange = function()
            {
                if (this.readyState == 4 && this.status == 200)
                {
                    alert("User updated");
                    getAllUsersToEdit();
                    $("#editUserModal").modal("toggle");
                }else if (this.readyState == 4 && this.status == 500)
                {
                    alert("User Update Error");
                }
            };

            xmlHttp.send(editUserData);
        }

         var deleteUserID;
    var deleteUserTableData;


    function startDeleteUser()
    {

        $("#searchDeleteUserModal").modal("toggle");
    }

    function searchIDtoDelete()
    {
        let myForm = document.getElementById('userEmailForm');
        let formData = new FormData(myForm);
        formData.forEach(function(value, key)
        { deleteUserID = value; });
        
        var xmlHttp = new XMLHttpRequest();
        var theURL = "http://localhost:8080/user/id/" + deleteUserID;
        
        xmlHttp.onreadystatechange = function()
        {
            if (this.readyState == 4 && this.status == 200)
            {

                deleteUserTableData = (this.responseText);
                console.log(deleteUserTableData);
                document.getElementById("userEmail").value = "";
                confirmDelete();
            }
            else if (this.readyState == 4 && this.status == 500)
            { 
                alert("User not found");
                //document.getElementById("userEmail").value = "";
                deleteUserID = null;
            }
        };
        xmlHttp.open("GET", theURL , true);
        xmlHttp.send();
    }

    function confirmDelete()
    { 
    
    document.getElementById("VDelinfo").innerHTML = "Are you sure you want to Delete " + deleteUserID + "?";
    $("#ConfirmDeleteModal").modal();
    }

    

    function deleteUser()
    {
        var xmlHttp = new XMLHttpRequest();
        var theURL = "http://localhost:8080/user/" + deleteUserID;
        xmlHttp.onreadystatechange = function()
        {
            if (this.readyState == 4 && this.status == 204)
            {
                alert("User succesfully deleted");
                deleteUserID = null;
                $("#ConfirmDeleteModal").modal("hide");
            }
        };
        xmlHttp.open("Delete", theURL , true);
        xmlHttp.send();
    }

    var allUsertableData;
    var allUsertableData2;
    var allUsertableData3;



    function startGetAllUsers()
    {

        getAllUsers();
        $("#allUsersModal").modal("toggle");

    }


    function getAllUsers()
        {
            var xmlHttp = new XMLHttpRequest();
            var theURL = "http://localhost:8080/user"
            xmlHttp.onreadystatechange = function()
            {
                console.log(this.status);
                if (this.readyState == 4 && this.status == 200)
                {
                 var myList1 = (this.responseText);
                 var localTD = JSON.parse(myList1);
                 allUsertableData = localTD;
                 buildTable();
                }
            };
            xmlHttp.open("GET", theURL , true);
            xmlHttp.send();
        }




    function buildTable()
    {

        table = new Tabulator("#allUsers-Table",
            {
                data:allUsertableData,
                layout:"fitColumns",
                paginationSize:5,
                movableColumns:true,
                resizableRows:true,
                printAsHtml:true,
                printHeader:"<h1>All Users<h1>",
                columns:[
                //{title:"ID", field:"uuid"},
                {title:"First Name", field:"firstname", hozAlign:"left"},
                {title:"Lastname", field:"lastname", hozAlign:"left"},
                {title:"Email", field:"email", hozAlign:"left"},
                {title:"Is Admin", field:"admin", hozAlign:"center", formatter:"tickCross"},],
                rowClick:function(e, row)
                {
                    
                    var rowData = row.getData();
                    var email = rowData.email;
                    
                    getAllUsersLicenses(rowData.uuid);
                    getAllUsersAssets(rowData.uuid);
                    // div.innerHTML = 'Name: ' + rowData.firstname + ' ' + rowData.lastname + ' Email: '+ rowData.email + ' Admin: ' + rowData.admin; 
                    
                    $("#allUsersModal").modal("toggle");
                    $("#userInfoModal").modal("toggle");
                }
            }
        );

    }



    function buildLicenseTable()
    {

        table = new Tabulator("#userLicense-Table",
            {
                data:allUsertableData2,
                layout:"fitColumns",
                paginationSize:5,
                movableColumns:true,
                resizableRows:true,
                printAsHtml:true,
                printHeader:"<h1>Assiged Licneses<h1>",
                columns:[
                // {title:"ID", field:"uuid"},
                {formatter:"rownum", hozAlign:"center", width:40},
                {title:"Software Name", field:"name", hozAlign:"left"},
                {title:"Version", field:"version", hozAlign:"left"},
                {title:"License Key", field:"license_key", hozAlign:"left"},
                {title:"Assignment Date", field:"assignmentDate", hozAlign:"left"},
                {title:"Approved?", field:"approved", hozAlign:"center", formatter:"tickCross"},],
                rowClick:function(e, row)
                {

                }
            }
        );

    }

    function buildAssetTable()
    {

        table = new Tabulator("#userAsset-Table",
            {
                data:allUsertableData3,
                layout:"fitColumns",
                paginationSize:5,
                movableColumns:true,
                resizableRows:true,
                printAsHtml:true,
                printHeader:"<h1>Assiged Licneses<h1>",
                columns:[
                // {title:"ID", field:"uuid"},
                {formatter:"rownum", hozAlign:"center", width:40},
                {title:"Hardware Name", field:"name", hozAlign:"left"},
                {title:"Model", field:"model", hozAlign:"left"},
                {title:"AssetTag", field:"assetTag", hozAlign:"left"},
                // {title:"Serial Number", field:"license_key", hozAlign:"left"},
                {title:"Assignment Date", field:"assignmentDate", hozAlign:"left"},
                {title:"Approved?", field:"approved", hozAlign:"center", formatter:"tickCross"},],
                rowClick:function(e, row)
                {

                }

                
            }
        );

    }

    function getAllUsersLicenses(userID)
        {
          var xmlHttp = new XMLHttpRequest();
          var theURL = "http://localhost:8080/license_assign/user/" + userID
          xmlHttp.onreadystatechange = function()
          {
                
                if (this.readyState == 4 && this.status == 200)
                {
                 var myList2 = (this.responseText);
                 var localTD = JSON.parse(myList2);
                 allUsertableData2 = localTD;
                 buildLicenseTable();
                }
            };
            xmlHttp.open("GET", theURL , true);
            xmlHttp.send();
        }

        function getAllUsersAssets(userID)
        {
          var xmlHttp = new XMLHttpRequest();
          var theURL = "http://localhost:8080/asset_assign/user/" + userID
          xmlHttp.onreadystatechange = function()
          {
                
                if (this.readyState == 4 && this.status == 200)
                {
                 var myList2 = (this.responseText);
                 var localTD = JSON.parse(myList2);
                 allUsertableData3 = localTD;
                 console.log(allUsertableData3);
                 buildAssetTable();
                }
            };
            xmlHttp.open("GET", theURL , true);
            xmlHttp.send();
        }

    document.getElementById("download-csv").addEventListener("click", function(){
    table.download("csv", "data.csv");});

    //trigger download of data.json file
    document.getElementById("download-json").addEventListener("click", function(){
        table.download("json", "data.json");});

    //trigger download of data.xlsx file
    document.getElementById("download-xlsx").addEventListener("click", function(){
        table.download("xlsx", "data.xlsx", {sheetName:"My Data"});});

    //trigger download of data.pdf file
    document.getElementById("download-pdf").addEventListener("click", function(){
        table.download("pdf", "data.pdf", {
            orientation:"portrait", //set page orientation to portrait
            title:"Example Report", //add title to report
        });});

    //trigger download of data.html file
    document.getElementById("download-html").addEventListener("click", function(){
        table.download("html", "data.html", {style:true});});

    document.getElementById("print-table").addEventListener("click", function(){
   table.print(false, true);});

</script>
</html>