<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="shortcut icon" href="#">
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>
    <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.0.5/jspdf.plugin.autotable.js"></script>
    <style>
        .container{
            height: 60px;
            position: relative;}
        .center {
            margin: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);}
        .wrapper {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 5px;}

        .btn-default {
            margin-right: 5px;
            margin-left: 5px;}
        #filter {
            margin: auto;
              width: 60%;
              border: 3px solid #73AD21;
              padding: 10px;}
        input[type=text] {
              width: 100%;
              padding: 12px 20px;
              margin: 8px 0;
              box-sizing: border-box;}
        .tabulator-print-header, tabulator-print-footer{
            text-align:center;}
     </style>
</head>
<body>
    <div class="container">
        <div class="center">
            <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#allUsersModal" onclick='startPage()' >All Users</button>
        </div>
    </div>
<div id="allUsersModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">All User</h4>
            </div>
            <div class="modal-body">
                <div class="wrapper">
                    <button id="download-csv" class="btn btn-default">Download CSV</button>
                    <button id="download-json" class="btn btn-default">Download JSON</button>
                    <button id="download-xlsx" class="btn btn-default">Download XLSX</button>
                    <button id="download-pdf" class="btn btn-default">Download PDF</button>
                    <button id="download-html" class="btn btn-default">Download HTML</button>
                    <button id="print-table"class="btn btn-default" >Print Table</button>
                    <button class="btn btn-default" onclick="showCmds()">Show Filters</button>
                </div>
                <br>
                <div id="filterCmds">
                    <div class="wrapper">
                        <select id="filter-field" class="form-control">
                            <option value="firstname">First Name</option>
                            <option value="lastname">Last Name</option>
                            <option value="email">Email</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="wrapper">
                        <select id="filter-type" class="form-control">
                            <option value="=">=</option>
                            <option value="<"><</option>
                            <option value="<="><=</option>
                            <option value=">">></option>
                            <option value=">=">>=</option>
                            <option value="!=">!=</option>
                            <option value="like">like</option>
                        </select>
                    </div>
                    <div class="wrapper">
                        <input id="filter-value" type="text" class="form-control" placeholder="value to filter">
                        <button id="filter-clear" type="button" class="btn btn-default">Clear</button>
                        <button class="btn btn-default" onclick="showCmds()">Hide Filters</button>
                    </div>
                </div>
                <br>
                <div id="allUsers-Table"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="userInfoModal" class="modal fade" role="dialog">
      <div class="modal-dialog modal-dialog-scrollable modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="usermodal-title">User Information</h4>
              </div>
              <div class="modal-body">
                <div id="userData"></div>
                  <br>
                  <h4>Licenses</h4>
                  <div id="userLicense-Table"></div>
                  <br>
                  <h4>Assets</h4>
                  <div id="userAsset-Table"></div>
              </div>

              <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
          </div>
      </div>
  </div>
</body>

</body>
<script>

    var tableData;
    var tableData2;
    var tableData3;

    var table;



    var fieldEl = document.getElementById("sort-field");
    var dirEl = document.getElementById("sort-direction");

    var cmds

    function startPage()
    {
        getUser();
        cmds = document.getElementById("filterCmds");
        cmds.style.display = ("none");
        rebuildTable();
    }


    function getUser()
        {
            var xmlHttp = new XMLHttpRequest();
            var theURL = "http://localhost:8080/user"
            xmlHttp.onreadystatechange = function()
            {
                console.log(this.status);
                if (this.readyState == 4 && this.status == 200)
                {
                 var myList1 = (this.responseText);
                 var localTD = JSON.parse(myList1);
                 tableData = localTD;
                 buildTable();
                }
            };
            xmlHttp.open("GET", theURL , true);
            xmlHttp.send();
        }

    function showCmds()
        {
            cmds = document.getElementById("filterCmds");
            if (cmds.style.display === "none") {
                cmds.style.display = "block";
            } else {
                cmds.style.display = "none";
            }
        }

    function rebuildTable()
        {
            table.redraw();
        }

    function buildTable()
    {

        table = new Tabulator("#allUsers-Table",
            {
                data:tableData,
                layout:"fitColumns",
                paginationSize:5,
                movableColumns:true,
                resizableRows:true,
                printAsHtml:true,
                printHeader:"<h1>All Users<h1>",
                columns:[
                //{title:"ID", field:"uuid"},
                {title:"First Name", field:"firstname", hozAlign:"left"},
                {title:"Lastname", field:"lastname", hozAlign:"left"},
                {title:"Email", field:"email", hozAlign:"left"},
                {title:"Is Admin", field:"admin", hozAlign:"center", formatter:"tickCross"},],
                rowClick:function(e, row)
                {
                    
                    var rowData = row.getData();
                    var email = rowData.email;
                    
                    getUserLicenses(rowData.uuid);
                    getUserAssets(rowData.uuid);
                    
                    var mainContainer = document.getElementById("userData");
                    var div = document.createElement("div");
                    div.innerHTML = 'Name: ' + rowData.firstname + ' ' + rowData.lastname + ' Email: '+ rowData.email + ' Admin: ' + rowData.admin; 
                    mainContainer.appendChild(div);
                    $("#allUsersModal").modal("toggle");
                    $("#userInfoModal").modal("toggle");
                }
            }
        );

    }



    function buildLicenseTable()
    {

        table = new Tabulator("#userLicense-Table",
            {
                data:tableData2,
                layout:"fitColumns",
                paginationSize:5,
                movableColumns:true,
                resizableRows:true,
                printAsHtml:true,
                printHeader:"<h1>Assiged Licneses<h1>",
                columns:[
                // {title:"ID", field:"uuid"},
                {formatter:"rownum", hozAlign:"center", width:40},
                {title:"Software Name", field:"name", hozAlign:"left"},
                {title:"Version", field:"version", hozAlign:"left"},
                {title:"License Key", field:"license_key", hozAlign:"left"},
                {title:"Assignment Date", field:"assignmentDate", hozAlign:"left"},
                {title:"Approved?", field:"approved", hozAlign:"center", formatter:"tickCross"},],
                rowClick:function(e, row)
                {

                }
            }
        );

    }

    function buildAssetTable()
    {

        table = new Tabulator("#userAsset-Table",
            {
                data:tableData3,
                layout:"fitColumns",
                paginationSize:5,
                movableColumns:true,
                resizableRows:true,
                printAsHtml:true,
                printHeader:"<h1>Assiged Licneses<h1>",
                columns:[
                // {title:"ID", field:"uuid"},
                {formatter:"rownum", hozAlign:"center", width:40},
                {title:"Hardware Name", field:"name", hozAlign:"left"},
                {title:"Model", field:"model", hozAlign:"left"},
                {title:"AssetTag", field:"assetTag", hozAlign:"left"},
                // {title:"Serial Number", field:"license_key", hozAlign:"left"},
                {title:"Assignment Date", field:"assignmentDate", hozAlign:"left"},
                {title:"Approved?", field:"approved", hozAlign:"center", formatter:"tickCross"},],
                rowClick:function(e, row)
                {

                }

                
            }
        );

    }

    function getUserLicenses(userID)
        {
          var xmlHttp = new XMLHttpRequest();
          var theURL = "http://localhost:8080/license_assign/user/" + userID
          xmlHttp.onreadystatechange = function()
          {
                
                if (this.readyState == 4 && this.status == 200)
                {
                 var myList2 = (this.responseText);
                 var localTD = JSON.parse(myList2);
                 tableData2 = localTD;
                 buildLicenseTable();
                }
            };
            xmlHttp.open("GET", theURL , true);
            xmlHttp.send();
        }

        function getUserAssets(userID)
        {
          var xmlHttp = new XMLHttpRequest();
          var theURL = "http://localhost:8080/asset_assign/user/" + userID
          xmlHttp.onreadystatechange = function()
          {
                
                if (this.readyState == 4 && this.status == 200)
                {
                 var myList2 = (this.responseText);
                 var localTD = JSON.parse(myList2);
                 tableData3 = localTD;
                 console.log(tableData3);
                 buildAssetTable();
                }
            };
            xmlHttp.open("GET", theURL , true);
            xmlHttp.send();
        }

    document.getElementById("download-csv").addEventListener("click", function(){
    table.download("csv", "data.csv");});

    //trigger download of data.json file
    document.getElementById("download-json").addEventListener("click", function(){
        table.download("json", "data.json");});

    //trigger download of data.xlsx file
    document.getElementById("download-xlsx").addEventListener("click", function(){
        table.download("xlsx", "data.xlsx", {sheetName:"My Data"});});

    //trigger download of data.pdf file
    document.getElementById("download-pdf").addEventListener("click", function(){
        table.download("pdf", "data.pdf", {
            orientation:"portrait", //set page orientation to portrait
            title:"Example Report", //add title to report
        });});

    //trigger download of data.html file
    document.getElementById("download-html").addEventListener("click", function(){
        table.download("html", "data.html", {style:true});});

    document.getElementById("print-table").addEventListener("click", function(){
   table.print(false, true);});

    //Define variables for input elements
    var fieldEl = document.getElementById("filter-field");
    var typeEl = document.getElementById("filter-type");
    var valueEl = document.getElementById("filter-value");


    //Trigger setFilter function with correct parameters
    function updateFilter(){
      var filterVal = fieldEl.options[fieldEl.selectedIndex].value;
      var typeVal = typeEl.options[typeEl.selectedIndex].value;

      var filter = filterVal == "function" ? customFilter : filterVal;

      if(filterVal == "function" ){
        typeEl.disabled = true;
        valueEl.disabled = true;
      }else{
        typeEl.disabled = false;
        valueEl.disabled = false;
      }

      if(filterVal){
        table.setFilter(filter,typeVal, valueEl.value);
      }
    }

    //Update filters on value change
    document.getElementById("filter-field").addEventListener("change", updateFilter);
    document.getElementById("filter-type").addEventListener("change", updateFilter);
    document.getElementById("filter-value").addEventListener("keyup", updateFilter);

    //Clear filters on "Clear Filters" button click
    document.getElementById("filter-clear").addEventListener("click", function(){
      fieldEl.value = "";
      typeEl.value = "";
      valueEl.value = "";

      table.clearFilter();
    });
</script>
</body>
</html>