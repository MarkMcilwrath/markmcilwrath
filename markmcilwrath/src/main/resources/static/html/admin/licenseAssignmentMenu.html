<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="UTF-8" content="width=device-width, initial-scale=1">
	    <title>License Assignment</title>

		<link rel="shortcut icon" href="#">
	    <script src="https://unpkg.com/@popperjs/core@2"></script>
	    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
	    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
	    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>
	    <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
	    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>
	    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.0.5/jspdf.plugin.autotable.js"></script>
	    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1">
	    <link href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round" rel="stylesheet">
	    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
	    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
	    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>

	    <link rel="stylesheet" href="../../project.css">

	    <script>
	    	$(function(){
	    		$("#includedContent").load("./adminMenu2.html");
	        });
	    </script>

</head>
<body>
	<div id="includedContent">
		</div>

		<div class="container">
    		<div class="center">
                <div class="menuButtonHolder">
                    <button type="button" class="btn btn-primary btn-lg btn-block"  onclick="startAssignLicense()" >Assign Licenses</button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="center">
                <div class="menuButtonHolder">
                    <button type="button" class="btn btn-primary btn-lg btn-block" onclick="startAllAssignments()">All Assigned Licenses</button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="center">
                <div class="menuButtonHolder">
                    <button type="button" class="btn btn-primary btn-lg btn-block" onclick="startUnassignLicense()">Uassign License</button>
                </div>
            </div>
        </div>

         <div class="container">
            <div class="center">
                <div class="menuButtonHolder">
                    <button type="button" class="btn btn-primary btn-lg btn-block" onclick="startApprove()">Approve License Request</button>
                </div>
            </div>
        </div>

<div id="assignSelectLicenseModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Free licenses</h4>
            </div>
            <div class="modal-body">
                <div>
                    <select class="selectpicker" id="aasignLicenseUserDDList" name="aasignLicenseUserDDList"></select>
                </div>
                <br>
                <div>
                    <div id="allFreeLicenses-Table"></div>
                </div>
                <br>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="tagAssignLicenseModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
              
            </div>
            <div class="modal-body">
                <h4>Add Request Tags</h4>
                <div>
                	<form>
                		<div>
							<label for="assignLicenseLocationTag">Location: </label>
							<input type="text" id="assignLicenseLocationTag" name="assignLicenseLocationTag">
						</div>
						<div>
							<label for="assignLicenseDepartmentTag">Department: </label>
							<input type="text" id="assignLicenseDepartmentTag" name="assignLicenseDepartmentTag">
						</div>
					</form>
                </div>
            </div>
            <div class="modal-body">
                <h4>Add Custom Tags</h4>
                <div>
                	<div id="tagholder"></div>
                	<button class="btn btn-default" onClick="addCustomTag()">Add Tag</button>
                	<!-- <button class="btn btn-default" onClick="removeCustomTag()" >Remove Tag</button> -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" onclick="validateAssignLicenseTags()">Confirm</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="confirmAssignLicenseModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
              
            </div>
            <div class="modal-body">
                <h4 id="confirm"></h4>
                <div>
                	
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" onclick="confirmAssinLicense()">Confirm</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="allAssignedLicenses" class="modal fade" role="dialog">
      <div class="modal-dialog modal-dialog-scrollable modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                 
                  <h4 class="modal-title">All Assigned Licneses</h4>
              </div>

              <div class="modal-body">
                  <div class="wrapper">
                      <button id="download-csv" class="btn btn-default">Download CSV</button>
                      <button id="download-json" class="btn btn-default">Download JSON</button>
                      <button id="download-xlsx" class="btn btn-default">Download XLSX</button>
                      <button id="download-pdf" class="btn btn-default">Download PDF</button>
                      <button id="download-html" class="btn btn-default">Download HTML</button>
                      <button id="print-table"class="btn btn-default" >Print Table</button>
                      <button class="btn btn-default" onclick="showCmds()">Show Filters</button>
                  </div>
                  <div id="filterCmds">
                      <div class="wrapper">
                          <select id="filter-field" class="form-control">
                              <option value="email">Email</option>
                              <option value="name">Software Name</option>
                              <option value="version">Version</option>
                              <option value="admin">Assignment Date</option>
                          </select>
                      </div>
                      <div class="wrapper">
                          <select id="filter-type" class="form-control">
                              <option value="=">=</option>
                              <option value="<"><</option>
                              <option value="<="><=</option>
                              <option value=">">></option>
                              <option value=">=">>=</option>
                              <option value="!=">!=</option>
                              <option value="like">like</option>
                          </select>
                      </div>

                      <div class="wrapper">
                          <input id="filter-value" type="text" class="form-control" placeholder="value to filter">
                          <button id="filter-clear" type="button" class="btn btn-default">Clear</button>
                          <button class="btn btn-default" onclick="showCmds()">Hide Filters</button>
                      </div>
                  </div>
                  <br>
                  <div id="assigned-Table"></div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
          </div>
      </div>
  </div>
</body>

  <div id="indAssignedLicenses" class="modal fade" role="dialog">
      <div class="modal-dialog modal-dialog-scrollable modal-lg">
          <div class="modal-content">
              <div class="modal-header">
                
                  <h4 class="modal-title">Assigned Licneses</h4>
              </div>
              <div class="modal-body">
                  <br>
                  <div id="indassigned-Table"></div>
                  <br>
                  <div id="indassignedTags-Table"></div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
          </div>
      </div>
  </div>
</body>

<div id="allAssignedUnassignLicenses" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">All Assigned Licneses</h4>
            </div>

            <div class="modal-body">
                <div id="unassignAssigned-Table"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
</body>


<div id="unassignConfirmModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
               
            </div>
            <div class="modal-body">
                <h4 id="confirmtext"></h4>
                <div>
                    <button id="download-csv" class="btn btn-default" onclick="confirmUnassign(unassignRowData.uuid)">Confirm</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="allUnapproveAssignedLicenses" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                
                <h4 class="modal-title">Unapproved Licneses</h4>
            </div>

            <div class="modal-body">
                
                <br>
                <div id="allUnapproveAssignedLicenses-Table"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
</body>

<div id="indUnAssignedLicenses" class="modal fade" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
           
                <h4 class="modal-title">Assigned Licneses</h4>
            </div>
            <div class="modal-body">
                <br>
                <div id="indAssigned-Table"></div>
                <br>
                <div id="indassignedTags-Table"></div>
                <div class="wrapper">
                  <button onclick="approveRequest()" class="btn btn-default">Approve</button>
                  <button onclick="rejectRequest()" class="btn btn-default">Reject</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script>

	var down = document.getElementById("tagFormHolder");
	var br = document.createElement("br"); 

	var tagCounter = 0;
	var tagData;
    var tagObject = {};

	var freeLicensesTableData;
    var assignLicenseData;

    var assignLicenseData
    var rowData;

    function startAssignLicense()
        {
            getFreeLicenses();
            getUsersToAssign();
            var tagCounter = 0;
            $("#assignSelectLicenseModal").modal("toggle");
        }

	function getFreeLicenses()
	    {
	        var xmlHttp = new XMLHttpRequest();
	        var theURL = "http://localhost:8080/license/free"
	        xmlHttp.onreadystatechange = function()
	        {
	            if (this.readyState == 4 && this.status == 200)
	            {
	             freeLicensesTableData = JSON.parse(this.responseText);
	             buildFreeLicensesTable();
	            }
	            else
	            {

	            }
	        };
	        xmlHttp.open("GET", theURL , true);
	        xmlHttp.send();
	    }

    function getUsersToAssign()
        {
            let uDropDown = document.getElementById('aasignLicenseUserDDList');
            uDropDown.length = 0;

            const url = 'http://localhost:8080/user';

            const request = new XMLHttpRequest();
            request.open('GET', url, true);

            request.onload = function()
            {
              if (request.status === 200)
              {
                const data = JSON.parse(request.responseText);
                let option;
                for (let i = 0; i < data.length; i++)
                {
                  option = document.createElement('option');
                  option.text = data[i].firstname + " " + data[i].lastname;
                  option.value = data[i].uuid;
                  console.log(option);
                  uDropDown.add(option);
                }
              }
              else
              {}   
                }

            request.onerror = function() {
              console.error('An error occurred fetching the JSON from ' + url);
            };

            request.send();
        }

    function buildFreeLicensesTable()
        {
            table = new Tabulator("#allFreeLicenses-Table",
            {
                data:freeLicensesTableData,
                layout:"fitColumns",
                paginationSize:5,
                movableColumns:true,
                resizableRows:true,
                printAsHtml:true,
                columns:[
                // {title:"ID", field:"uuid"},
                {title:"Software", field:"softwareName", hozAlign:"left"},
                {title:"Version", field:"softwareVersion", hozAlign:"left"},
                {title:"Purchase Date", field:"purchaseDate", hozAlign:"left"},
                {title:"Expiry Date", field:"expiryDate", hozAlign:"left"},
                {title:"License Key", field:"licenseKey", hozAlign:"left"},
                ],
                rowClick:function(e, row)
                {
                    rowData = row.getData();
                    console.log(rowData);
                    
                     $("#assignSelectLicenseModal").modal("toggle");
                     $("#tagAssignLicenseModal").modal("toggle");
                     // $("#confirmAssignLicenseModal").modal("toggle");
                }
                }
                );
        }

    function addCustomTag()
	    {
	    	tagCounter++;
	        var formtag = document.createElement("form");
	        var tk = document.createElement("input");
	        var identKey = "key" + tagCounter;

	        tk.setAttribute("type", "text");
	        tk.setAttribute("name", "key");
	        tk.setAttribute("id", identKey);
	        tk.setAttribute("placeholder", "Tag Name");

	        var identValue = "value" + tagCounter;

	        var tv = document.createElement("input");
	        tv.setAttribute("type", "text");
	        tv.setAttribute("name", "value");
	        tv.setAttribute("id", identValue);
	        tv.setAttribute("placeholder", "Tag Value");

	        formtag.appendChild(tk); 
	        formtag.appendChild(tv); 
	        formtag.appendChild(br.cloneNode()); 
	       
	        document.getElementById("tagholder").appendChild(formtag);
	        console.log(tagCounter);
	    }

    function submitTags()
	    {
	    	let customTagForm;
	    	let customTagFormData = new FormData(customTagForm);

	    	
	    	var location = document.getElementById("assignLicenseLocationTag").value;
	    	var department = document.getElementById("assignLicenseDepartmentTag").value;

	    	customTagFormData.append("location", location);
	    	customTagFormData.append("department", department);

	    	for (i = 1; i <= tagCounter; i++)
	    	{
	    		var identKey = 'key' + i;
	    		var identValue = 'value' + i;

	    		var keyValue = document.getElementById(identKey).value;
	    		var valueValue = document.getElementById(identValue).value;

	    		customTagFormData.append(keyValue, valueValue);
	    	}
	    	
	        customTagFormData.forEach(function(value, key)
	        {
	        tagObject[key] = value;
	        });

	        tagData = JSON.stringify(tagObject);

            assignLicense();
	        $("#tagAssignLicenseModal").modal("toggle");
	        $("#confirmAssignLicenseModal").modal("toggle");
	    }

    function validateAssignLicenseTags()
	    {
	    	var tag1 = document.getElementById("assignLicenseLocationTag").value;
		    var tag2 = document.getElementById("assignLicenseDepartmentTag").value;  

		        if (tag1 == "")
		        {
		            alert("Location Tag Missing");
		        }
		        else if (tag2 == "")
		        {
		            alert("Department Tag Missing");
		        }
		        else
		        {
		            submitTags();
		        }
	    }

    function assignLicense()
        {
            var license_key = rowData.licenseKey;
            var selectedUser = (document.getElementById("aasignLicenseUserDDList"));
            var selectedUserID = selectedUser.value;
            
            var newObject = {};

            newObject['license_key'] = license_key;
            newObject['user_id'] = selectedUserID;
            newObject['tags'] = tagObject;
            assignLicenseData = JSON.stringify(newObject);


            document.getElementById("confirm").innerHTML = "Assign: " + rowData.softwareName + " " + rowData.softwareVersion + " [" + rowData.licenseKey + "]";
        }

    function confirmAssinLicense()
        {
        	console.log(assignLicenseData);
            var xmlHttp = new XMLHttpRequest();

            var theUrl = "http://localhost:8080/license_assign/add/admin";
            xmlHttp.open("POST", theUrl);
            xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");


            xmlHttp.onreadystatechange = function()
            {
                if (this.readyState == 4 && this.status == 201)
                {
                    alert("License Assigned");
                    getFreeLicenses();
                    $("#confirmAssignLicenseModal").modal("toggle");

                }else if (this.readyState == 4 && this.status != 201)
                {
                    alert("Assignment Registration Error");
                }
            };

            xmlHttp.send(assignLicenseData);


        }

    var assignedTableData;
    var indAssignedTableData;
    var indAssignedTagsTableData


    var fieldEl = document.getElementById("sort-field");
    var dirEl = document.getElementById("sort-direction");

    var cmds

    function startAllAssignments()
        {
            getAllAssignments();
            cmds = document.getElementById("filterCmds");
            cmds.style.display = ("none");
            $("#allAssignedLicenses").modal("toggle");
        }

    function getAllAssignments()
        {
            var xmlHttp = new XMLHttpRequest();
            var theURL = "http://localhost:8080/license_assign"
            xmlHttp.onreadystatechange = function()
            {
                console.log(this.status);
                if (this.readyState == 4 && this.status == 200)
                {
                 var myList1 = (this.responseText);
                 var localTD = JSON.parse(myList1);
                 assignedTableData= localTD;
                 buildAllAsigmnetsTable();
                }
            };
            xmlHttp.open("GET", theURL , true);
            xmlHttp.send();
        }

    function getIndAssign(assignmentID)
        {
          var xmlHttp = new XMLHttpRequest();
          var theURL = "http://localhost:8080/license_assign/set/" + assignmentID
          xmlHttp.onreadystatechange = function()
          {
                
                if (this.readyState == 4 && this.status == 200)
                {
                 var myList2 = (this.responseText);
                 var localTD = JSON.parse(myList2);
                 indAssignedTableData = localTD;
                 buildIndTable();
                }
            };
            xmlHttp.open("GET", theURL , true);
            xmlHttp.send();
        }

    function showCmds()
        {
            cmds = document.getElementById("filterCmds");
            if (cmds.style.display === "none") {
                cmds.style.display = "block";
            } else {
                cmds.style.display = "none";
            }
        }

    function buildAllAsigmnetsTable()
        {

            table = new Tabulator("#assigned-Table",
                {
                    data:assignedTableData,
                    layout:"fitColumns",
                    paginationSize:5,
                    movableColumns:true,
                    resizableRows:true,
                    printAsHtml:true,
                    printHeader:"<h1>Assiged Licneses<h1>",
                    columns:[
                    // {title:"ID", field:"uuid"},
                    {formatter:"rownum", hozAlign:"center", width:40},
                    {title:"User Email", field:"email", hozAlign:"left"},
                    {title:"Software Name", field:"name", hozAlign:"left"},
                    {title:"Version", field:"version", hozAlign:"left"},
                    {title:"License Key", field:"license_key", hozAlign:"left"},
                    {title:"Assignment Date", field:"assignmentDate", hozAlign:"left"},
                    {title:"Approved?", field:"approved", hozAlign:"center", formatter:"tickCross"},],
                    rowClick:function(e, row)
                    {
                      var rowData = row.getData();
                      $("#allAssignedLicenses").modal("toggle");
                      getIndAssign(rowData.uuid);
                      getTagsForIndAssignment(rowData.uuid);
                      $("#indAssignedLicenses").modal("toggle");
                    }
                }
            );

        }

    function buildIndTable()
        {

            table = new Tabulator("#indassigned-Table",
                {
                    data:indAssignedTableData,
                    layout:"fitColumns",
                    paginationSize:5,
                    movableColumns:true,
                    resizableRows:true,
                    printAsHtml:true,
                    printHeader:"<h1>Assiged Licneses<h1>",
                    columns:[
                    // {title:"ID", field:"uuid"},
                    {formatter:"rownum", hozAlign:"center", width:40},
                    {title:"User Email", field:"email", hozAlign:"left"},
                    {title:"Software Name", field:"name", hozAlign:"left"},
                    {title:"Version", field:"version", hozAlign:"left"},
                    {title:"License Key", field:"license_key", hozAlign:"left"},
                    {title:"Assignment Date", field:"assignmentDate", hozAlign:"left"},
                    {title:"Approved?", field:"approved", hozAlign:"center", formatter:"tickCross"},],
                    rowClick:function(e, row)
                    {

                    }
                }
            );

        }

    function getTagsForIndAssignment(assignmentID)
        {
          var xmlHttp = new XMLHttpRequest();
          var theURL = "http://localhost:8080/license_assign/tags/" + assignmentID;
          xmlHttp.onreadystatechange = function()
          {
                
                if (this.readyState == 4 && this.status == 200)
                {
                 var myList2 = (this.responseText);
                 var localTD = JSON.parse(myList2);
                 indAssignedTagsTableData = localTD;
                 buildTagTable();
                 
                }
            };
            xmlHttp.open("GET", theURL , true);
            xmlHttp.send();

        }

    function buildTagTable()
        {

            table = new Tabulator("#indassignedTags-Table",
                {
                    data:indAssignedTagsTableData,
                    layout:"fitColumns",
                    paginationSize:5,
                    movableColumns:true,
                    resizableRows:true,
                    printAsHtml:true,
                    printHeader:"<h1>Assiged Licnese Tags<h1>",
                    columns:[
                    // {title:"ID", field:"uuid"},
                    {formatter:"rownum", hozAlign:"center", width:40},
                    {title:"Tag", field:"tagKey", hozAlign:"left"},
                    {title:"Value", field:"tagValue", hozAlign:"left"},],
                    rowClick:function(e, row)
                    {

                    }
                }
            );

        }


    document.getElementById("download-csv").addEventListener("click", function(){
    table.download("csv", "data.csv");});

    //trigger download of data.json file
    document.getElementById("download-json").addEventListener("click", function(){
        table.download("json", "data.json");});

    //trigger download of data.xlsx file
    document.getElementById("download-xlsx").addEventListener("click", function(){
        table.download("xlsx", "data.xlsx", {sheetName:"My Data"});});

    //trigger download of data.pdf file
    document.getElementById("download-pdf").addEventListener("click", function(){
        table.download("pdf", "data.pdf", {
            orientation:"portrait", //set page orientation to portrait
            title:"Example Report", //add title to report
        });});

    //trigger download of data.html file
    document.getElementById("download-html").addEventListener("click", function(){
        table.download("html", "data.html", {style:true});});

    document.getElementById("print-table").addEventListener("click", function(){
   table.print(false, true);});

    //Define variables for input elements
    var fieldEl = document.getElementById("filter-field");
    var typeEl = document.getElementById("filter-type");
    var valueEl = document.getElementById("filter-value");


    //Trigger setFilter function with correct parameters
    function updateFilter(){
      var filterVal = fieldEl.options[fieldEl.selectedIndex].value;
      var typeVal = typeEl.options[typeEl.selectedIndex].value;

      var filter = filterVal == "function" ? customFilter : filterVal;

      if(filterVal == "function" ){
        typeEl.disabled = true;
        valueEl.disabled = true;
      }else{
        typeEl.disabled = false;
        valueEl.disabled = false;
      }

      if(filterVal){
        table.setFilter(filter,typeVal, valueEl.value);
      }
    }

    //Update filters on value change
    document.getElementById("filter-field").addEventListener("change", updateFilter);
    document.getElementById("filter-type").addEventListener("change", updateFilter);
    document.getElementById("filter-value").addEventListener("keyup", updateFilter);

    //Clear filters on "Clear Filters" button click
    document.getElementById("filter-clear").addEventListener("click", function(){
      fieldEl.value = "";
      typeEl.value = "";
      valueEl.value = "";

      table.clearFilter();
    });

    var assignedLicensesTableData;

    var unassignRowData;

    var unassigncCommands;

    function startUnassignLicense()
    {
        getAssignments();
        $("#allAssignedUnassignLicenses").modal("toggle");
    }

    function getAssignments()
        {
            var xmlHttp = new XMLHttpRequest();
            var theURL = "http://localhost:8080/license_assign"
            xmlHttp.onreadystatechange = function()
            {
                console.log(this.status);
                if (this.readyState == 4 && this.status == 200)
                {
                 var myList1 = (this.responseText);
                 var localTD = JSON.parse(myList1);
                 assignedLicensesTableData = localTD;
                 buildUnassignTable(assignedLicensesTableData);
                }
            };
            xmlHttp.open("GET", theURL , true);
            xmlHttp.send();
        }

    function buildUnassignTable(data)
        {

            table = new Tabulator("#unassignAssigned-Table",
                {
                    data:assignedLicensesTableData,
                    layout:"fitColumns",
                    paginationSize:5,
                    movableColumns:true,
                    resizableRows:true,
                    printAsHtml:true,
                    printHeader:"<h1>Assiged Licneses<h1>",
                    columns:[
                    // {title:"ID", field:"uuid"},
                    {formatter:"rownum", hozAlign:"center", width:40},
                    {title:"User Email", field:"email", hozAlign:"left"},
                    {title:"Software Name", field:"name", hozAlign:"left"},
                    {title:"Version", field:"version", hozAlign:"left"},
                    {title:"License Key", field:"license_key", hozAlign:"left"},
                    {title:"Assignment Date", field:"assignmentDate", hozAlign:"left"},
                    {title:"Approved?", field:"approved", hozAlign:"center", formatter:"tickCross"},],
                    rowClick:function(e, row)
                    {
                      unassignRowData = row.getData();
                      console.log(unassignRowData);
                      $("#allAssignedUnassignLicenses").modal("toggle");
                      unassignLicensePrompt(unassignRowData);
                      $("#unassignConfirmModal").modal("toggle");
                      
                    }
                }
            );

        }

    function unassignLicensePrompt(unassignRowData)
        {
            document.getElementById("confirmtext").innerHTML = "Unassign: " + unassignRowData.name + " " + unassignRowData.version + " [" + unassignRowData.license_key + "] from " + unassignRowData.email;
        }

    function confirmUnassign(assignmentID)
        {
          var xmlHttp = new XMLHttpRequest();
          var theURL = "http://localhost:8080/license_assign/" + assignmentID;
          xmlHttp.onreadystatechange = function()
          {
            if (this.readyState == 4 && this.status == 204)
              {
                alert("License unassigned");
                getAssignments();
                $("#unassignConfirmModal").modal("toggle");
              }
              else if (this.readyState == 4 && this.status != 204)
              {
                alert("ERROR");
              }
            };
        xmlHttp.open("Delete", theURL , true);
        xmlHttp.send();
        }
    
    var unApprovedtableData;
    var unApprovedtableData2;
    
    var approveID;

    function startApprove()
      {
          getOpenAssignments();
          $("#allUnapproveAssignedLicenses").modal("toggle");
      }

    function getOpenAssignments()
      {
        approveID = null;
          var xmlHttp = new XMLHttpRequest();
          var theURL = "http://localhost:8080/license_assign/approve"
          xmlHttp.onreadystatechange = function()
          {
              console.log(this.status);
              if (this.readyState == 4 && this.status == 200)
              {
               var myList1 = (this.responseText);
               var localTD = JSON.parse(myList1);
               unApprovedtableData = localTD;
               buildUnapprovedTable();
              }
          };
          xmlHttp.open("GET", theURL , true);
          xmlHttp.send();
      }

    function getIndUnapproveAssignment(assignID)
      {
          var xmlHttp = new XMLHttpRequest();
          var theURL = "http://localhost:8080/license_assign/set/" + assignID
          xmlHttp.onreadystatechange = function()
          {
              console.log(this.status);
              if (this.readyState == 4 && this.status == 200)
              {
               var myList1 = (this.responseText);
               var localTD = JSON.parse(myList1);
               unApprovedtableData2 = localTD;
               buildIndUnapprovedTable();
              }
          };
          xmlHttp.open("GET", theURL , true);
          xmlHttp.send();
      }

    function buildUnapprovedTable()
      {

          table = new Tabulator("#allUnapproveAssignedLicenses-Table",
              {
                  data:unApprovedtableData,
                  layout:"fitColumns",
                  paginationSize:5,
                  movableColumns:true,
                  resizableRows:true,
                  printAsHtml:true,
                  printHeader:"<h1>Assiged Licneses<h1>",
                  columns:[
                  // {title:"ID", field:"uuid"},
                  {formatter:"rownum", hozAlign:"center", width:40},
                  {title:"User Email", field:"email", hozAlign:"left"},
                  {title:"Software Name", field:"name", hozAlign:"left"},
                  {title:"Version", field:"version", hozAlign:"left"},
                  {title:"License Key", field:"license_key", hozAlign:"left"},
                  {title:"Assignment Date", field:"assignmentDate", hozAlign:"left"},
                  {title:"Approved?", field:"approved", hozAlign:"center", formatter:"tickCross"},],
                  rowClick:function(e, row)
                  {
                    var rowData = row.getData();
                    approveID = rowData.uuid;
                    getIndUnapproveAssignment(rowData.uuid);
                    $("#allUnapproveAssignedLicenses").modal("toggle");
                    $("#indUnAssignedLicenses").modal("toggle");
                  }
              }
          );

      }

    function buildIndUnapprovedTable()
          {

              table2 = new Tabulator("#indAssigned-Table",
                  {
                      data:unApprovedtableData2,
                      layout:"fitColumns",
                      paginationSize:5,
                      movableColumns:true,
                      resizableRows:true,
                      printAsHtml:true,
                      printHeader:"",
                      columns:[
                      // {title:"ID", field:"uuid"},
                      {title:"User Email", field:"email", hozAlign:"left"},
                      {title:"Software Name", field:"name", hozAlign:"left"},
                      {title:"Version", field:"version", hozAlign:"left"},
                      {title:"License Key", field:"license_key", hozAlign:"left"},
                      {title:"Assignment Date", field:"assignmentDate", hozAlign:"left"},
                      {title:"Approved?", field:"approved", hozAlign:"center", formatter:"tickCross"},],
                      rowClick:function(e, row)
                      {
                        
                      }
                  }
              );

          }

    function approveRequest()
        {
          var xmlHttp = new XMLHttpRequest();
          var theUrl = "http://localhost:8080/license_assign/update/" + approveID;
          xmlHttp.open("PUT", theUrl);
          xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
          xmlHttp.onreadystatechange = function()
          {
            console.log(this.status);
            if (this.readyState == 4 && this.status == 200)
              {
                alert("License Approved");
                getOpenAssignments();
                $("#indUnAssignedLicenses").modal("toggle");
              }
              else if (this.readyState == 4 && this.status != 200)
              {
                alert("Approval Error");
              }
          };
          xmlHttp.send();
        }

    function rejectRequest()
        {
          var xmlHttp = new XMLHttpRequest();
              var theURL = "http://localhost:8080/license_assign/" + approveID;
              xmlHttp.onreadystatechange = function()
              {
                if (this.readyState == 4 && this.status == 204)
                  {
                    alert("License unassigned");
                    getOpenAssignments();
                    $("#indUnAssignedLicenses").modal("toggle");
                  }
                  else if (this.readyState == 4 && this.status != 204)
                  {
                    alert("ERROR");
                  }
                };
            xmlHttp.open("Delete", theURL , true);
            xmlHttp.send();
        }

</script>
</body>
</html>